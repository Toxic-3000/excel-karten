<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spieleliste – Test v5.1</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; margin:0; background:#f4f4f4; }
  header { padding:12px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.1); position:sticky; top:0; z-index:10; }
  h1 { margin:0 0 8px 0; font-size:1.2rem; }
  input[type=file] { width:100%; }
  .pill { display:inline-block; padding:8px 10px; border-radius:999px; background:#eee; margin-top:8px; font-size:.9rem; }
  .ok { background:#cfe8d5; }
  .bad { background:#f3c8c8; }
  .card { background:#fff; margin:12px; padding:12px; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
  code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
</style>
</head>
<body>

<header>
  <h1>Spieleliste (Test v5.1)</h1>

  <div class="pill ok" id="jsAlive">JS: lädt…</div>
  <div class="pill" id="status">Status: bereit</div>
  <div class="pill" id="fileName">Datei: —</div>

  <div style="margin-top:10px;">
    <input id="file" type="file" accept=".xlsx" onchange="window._fileChanged(event)">
  </div>

  <div class="pill" style="display:block;margin-top:10px;">
    Wenn hier <b>JS: läuft</b> nicht erscheint, läuft dein Viewer ohne JavaScript (z. B. Datei-Preview-App).
  </div>
</header>

<main id="list"></main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const setStatus = (msg, bad=false) => {
    const el = $('status');
    el.textContent = 'Status: ' + msg;
    el.classList.toggle('bad', !!bad);
  };
  const setFile = (msg) => $('fileName').textContent = 'Datei: ' + msg;

  // Prove JS is running immediately
  $('jsAlive').textContent = 'JS: läuft (' + new Date().toLocaleTimeString() + ')';

  // Global handler for inline onchange (more robust on some Android viewers)
  window._fileChanged = async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) { setFile('—'); setStatus('keine Datei gewählt'); return; }
    setFile(f.name + ' (' + Math.round(f.size/1024) + ' KB)');
    setStatus('Datei gewählt – prüfe XLSX…');

    if (typeof XLSX === 'undefined') {
      setStatus('XLSX nicht geladen (CDN geblockt?)', true);
      return;
    }

    try {
      setStatus('Lese Datei…');
      const buf = await f.arrayBuffer();
      const wb = XLSX.read(buf, { type:'array' });
      const sheet = wb.SheetNames[0];
      const ws = wb.Sheets[sheet];
      const rows = XLSX.utils.sheet_to_json(ws, { defval:'' });
      setStatus('OK – Zeilen: ' + rows.length + ' – Sheet: ' + sheet);

      render(rows);
    } catch (err) {
      setStatus('FEHLER beim Lesen: ' + (err && err.message ? err.message : String(err)), true);
    }
  };

  function render(rows){
    const root = $('list');
    root.innerHTML = '';
    rows.slice(0, 20).forEach(r => {
      const title = r.Spieletitel || r.Spiel || r.Titel || r.Title || '(kein Titel gefunden)';
      const d = document.createElement('div');
      d.className = 'card';
      d.innerHTML = '<b>' + escapeHtml(String(title)) + '</b><div style="margin-top:6px;color:#666;font-size:.9rem;">Preview</div>';
      root.appendChild(d);
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
})();
</script>

<!-- XLSX via CDN (as before) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
