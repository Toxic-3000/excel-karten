<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Excel → Karten</title>

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; color: #111; }

    header{
      position: sticky; top: 0; z-index: 10;
      background:#fff; border-bottom:1px solid #e7e7e7;
      padding:12px 14px; display:grid; gap:10px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    input[type="file"]{ max-width:100%; }
    input[type="search"], select, button{
      flex:1; min-width:170px;
      padding:10px 12px; border:1px solid #ddd; border-radius:12px;
      background:#fff; font-size:14px;
    }
    button{ cursor:pointer; }
    button:disabled{ opacity:.6; cursor:not-allowed; }

    main{ padding:14px; }
    .hint{ color:#666; font-size:13px; line-height:1.4; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(290px, 1fr));
      gap:12px;
    }
    .card{
      background:#fff; border:1px solid #e9e9e9; border-radius:16px;
      padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04);
      display:grid; gap:10px;
    }
    .title{ font-weight:700; font-size:16px; line-height:1.2; }
    .meta{ font-size:12px; color:#555; display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ background:#eef2ff; color:#2536a4; padding:4px 8px; border-radius:999px; }
    .kv{ display:grid; gap:6px; }
    .kv .line{ display:grid; grid-template-columns:120px 1fr; gap:10px; align-items:start; }
    .k{ color:#666; font-size:12px; }
    .v{ font-size:13px; word-break:break-word; }

    details{ border-top:1px solid #eee; padding-top:8px; }
    summary{ cursor:pointer; color:#2536a4; font-size:13px; user-select:none; }

    a{ color:#2536a4; text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .urlhint{
      display:block;
      margin-top:4px;
      font-size:11px;
      color:#777;
      word-break: break-all;
    }

    .footer{ padding:0 14px 14px; color:#666; font-size:12px; }
  </style>
</head>

<body>
<header>
  <div class="row">
    <strong>Excel → Karten</strong>
    <span class="hint">XLSX + Hyperlinks (Store Link klickbar, URL als Tooltip)</span>
  </div>

  <div class="row">
    <input id="file" type="file" accept=".xlsx,.xls,.csv">
    <select id="sheetSelect" disabled>
      <option>Sheet auswählen…</option>
    </select>
  </div>

  <div class="row">
    <input id="search" type="search" placeholder="Suche… (z.B. 'Yakuza', 'Capcom', '643')" disabled>
    <button id="moreBtn" disabled>Mehr laden</button>
    <button id="topBtn" disabled>↑ Top</button>
  </div>

  <div class="row">
    <span class="hint" id="status">Datei wählen → (XLSX: Sheet wählen) → suchen.</span>
  </div>
</header>

<main>
  <div id="grid" class="grid"></div>
</main>

<div id="footer" class="footer"></div>

<!-- SheetJS lokal im Repo -->
<script src="xlsx.full.min.js"></script>

<script>
  const els = {
    file: document.getElementById("file"),
    sheetSelect: document.getElementById("sheetSelect"),
    search: document.getElementById("search"),
    moreBtn: document.getElementById("moreBtn"),
    topBtn: document.getElementById("topBtn"),
    status: document.getElementById("status"),
    grid: document.getElementById("grid"),
    footer: document.getElementById("footer"),
  };

  // === Performance-Tuning für große Listen ===
  const INITIAL_RENDER = 0;     // 0 = erst nach Suche rendern (Android-freundlich)
  const PAGE_SIZE = 70;         // Karten pro "Mehr laden"
  const MAX_RESULTS = 280;      // DOM-Sicherheitslimit
  const LIGHT_FIELDS = 8;       // oben: wenige Felder
  const HEAVY_KEYS = new Set(["Kurzbeschreibung", "Beschreibung", "Notes", "Notizen"]);

  // Tooltip/URL-Anzeige
  const SHOW_URL_UNDER_LINK = false; // true => URL zusätzlich klein unter dem Link anzeigen

  let workbook = null;
  let allRows = [];
  let columns = [];

  let currentMatches = [];
  let shown = 0;

  function s(v){ return v == null ? "" : String(v).trim(); }

  function pickTitle(row){
    for (const k of ["Spieletitel","Spiel","Titel","Name"]) {
      const v = row[k];
      const t = (typeof v === "object" && v?.text != null) ? s(v.text) : s(v);
      if (t) return t;
    }
    return "(ohne Titel)";
  }

  function pickSubtitle(row){
    for (const k of ["Entwickler","Developer","Studio"]) {
      const v = row[k];
      const t = (typeof v === "object" && v?.text != null) ? s(v.text) : s(v);
      if (t) return t;
    }
    return "";
  }

  function pillsOf(row){
    const out = [];
    for (const k of ["ID","Subgenre / Stimmung","Subgenre","Genre"]) {
      const v = row[k];
      const t = (typeof v === "object" && v?.text != null) ? s(v.text) : s(v);
      if (t) out.push(k + ": " + t);
      if (out.length >= 3) break;
    }
    return out;
  }

  function cellToText(val){
    if (val && typeof val === "object") return s(val.text ?? "");
    return s(val);
  }

  function rowMatches(row, q){
    if (!q) return true;
    const needle = q.toLowerCase();

    // schneller "Teilscan" auf typische Felder
    const parts = [];
    for (const k of ["ID","Spieletitel","Spiel","Titel","Name","Entwickler","Developer","Studio","Subgenre / Stimmung","Subgenre","Genre"]) {
      if (row[k] !== undefined) parts.push(cellToText(row[k]));
    }
    const base = parts.join(" | ").toLowerCase();
    if (base.includes(needle)) return true;

    // fallback: Vollscan (langsamer, aber zuverlässig)
    const full = columns.map(c => cellToText(row[c])).join(" | ").toLowerCase();
    return full.includes(needle);
  }

  // === Link-Rendering: Store Link klickbar + URL als Tooltip ===
  function renderValueAsNode(value) {
    // (1) Hyperlink-Objekt aus XLSX
    if (value && typeof value === "object" && value.href) {
      const a = document.createElement("a");
      a.href = value.href;
      a.textContent = value.text ?? value.href;
      a.target = "_blank";
      a.rel = "noopener noreferrer";

      // Tooltip: echte URL
      a.title = value.href;

      // optional: URL unter dem Link anzeigen (mobile-friendly)
      if (SHOW_URL_UNDER_LINK) {
        const wrap = document.createElement("span");
        wrap.appendChild(a);
        const small = document.createElement("span");
        small.className = "urlhint";
        small.textContent = value.href;
        wrap.appendChild(small);
        return wrap;
      }

      return a;
    }

    // (2) Fallback: normaler Text
    return document.createTextNode(cellToText(value));
  }

  function makeLine(k, value){
    const line = document.createElement("div");
    line.className = "line";

    const kk = document.createElement("div");
    kk.className = "k";
    kk.textContent = k;

    const vv = document.createElement("div");
    vv.className = "v";
    vv.textContent = "";
    vv.appendChild(renderValueAsNode(value));

    line.appendChild(kk);
    line.appendChild(vv);
    return line;
  }

  function createCard(row){
    const card = document.createElement("div");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = pickTitle(row);

    const meta = document.createElement("div");
    meta.className = "meta";
    const sub = pickSubtitle(row);
    if (sub) meta.textContent = sub;

    const pillsWrap = document.createElement("div");
    pillsWrap.className = "meta";
    for (const p of pillsOf(row)) {
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = p;
      pillsWrap.appendChild(pill);
    }

    const kv = document.createElement("div");
    kv.className = "kv";

    // leichte Felder oben
    let used = 0;
    for (const k of columns) {
      if (used >= LIGHT_FIELDS) break;
      const v = row[k];
      const text = cellToText(v);
      if (!text) continue;
      if (HEAVY_KEYS.has(k)) continue;
      kv.appendChild(makeLine(k, v));
      used++;
    }

    // Details: alles, inkl. "schwere" Texte
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = "Details anzeigen";
    details.appendChild(summary);

    const detailsKv = document.createElement("div");
    detailsKv.className = "kv";
    for (const k of columns) {
      const v = row[k];
      const text = cellToText(v);
      if (!text) continue;
      detailsKv.appendChild(makeLine(k, v));
    }
    details.appendChild(detailsKv);

    card.appendChild(title);
    if (sub) card.appendChild(meta);
    if (pillsWrap.childNodes.length) card.appendChild(pillsWrap);
    if (kv.childNodes.length) card.appendChild(kv);
    card.appendChild(details);

    return card;
  }

  function updateUI(){
    const total = currentMatches.length;
    const cap = Math.min(total, MAX_RESULTS);

    els.footer.textContent =
      `Zeilen: ${allRows.length} | Treffer: ${total} | Angezeigt: ${shown}/${cap} | Spalten: ${columns.length}`;

    els.moreBtn.disabled = !(shown < cap);
  }

  function renderMore(){
    const total = currentMatches.length;
    const limit = Math.min(total, MAX_RESULTS);
    if (shown >= limit) return;

    const end = Math.min(shown + PAGE_SIZE, limit);
    const frag = document.createDocumentFragment();
    for (let i = shown; i < end; i++){
      frag.appendChild(createCard(currentMatches[i]));
    }
    els.grid.appendChild(frag);
    shown = end;

    els.status.textContent =
      total === 0 ? "Keine Treffer. Anderes Wort probieren."
      : (shown < limit
          ? `Treffer: ${total}. Angezeigt: ${shown}/${limit}. (Mehr laden für weitere)`
          : `Treffer: ${total}. Angezeigt: ${shown}/${limit}.`);

    updateUI();
  }

  function startSearch(q){
    els.grid.innerHTML = "";
    shown = 0;

    const query = (q || "").trim();
    if (!query && INITIAL_RENDER === 0){
      currentMatches = [];
      els.status.textContent = "Großes Sheet → bitte erst suchen (damit Android nicht explodiert).";
      updateUI();
      return;
    }

    els.status.textContent = "Suche läuft…";
    setTimeout(() => {
      currentMatches = allRows.filter(r => rowMatches(r, query));
      renderMore();
    }, 0);
  }

  // === XLSX: Worksheet -> Rows inkl. Hyperlinks ===
  function buildRowsFromWorksheet(ws) {
    const ref = ws["!ref"];
    if (!ref) return { columns: [], rows: [] };

    const range = XLSX.utils.decode_range(ref);
    const headerRow = range.s.r;

    const headers = [];
    for (let c = range.s.c; c <= range.e.c; c++) {
      const addr = XLSX.utils.encode_cell({ r: headerRow, c });
      const cell = ws[addr];
      headers.push((cell && cell.v != null) ? String(cell.v).trim() : "");
    }
    const cols = headers.map((h, i) => h || `Spalte_${i + 1}`);

    const rows = [];
    for (let r = headerRow + 1; r <= range.e.r; r++) {
      const obj = {};
      let any = false;

      for (let c = range.s.c; c <= range.e.c; c++) {
        const key = cols[c - range.s.c];
        const addr = XLSX.utils.encode_cell({ r, c });
        const cell = ws[addr];

        if (!cell || cell.v == null) { obj[key] = ""; continue; }

        any = true;

        const href = cell.l && cell.l.Target ? String(cell.l.Target) : null;
        if (href) {
          // Tooltip soll die echte URL zeigen; Linktext bleibt Zelltext (z.B. "Store Link")
          obj[key] = { text: String(cell.v), href };
        } else {
          obj[key] = String(cell.v);
        }
      }

      if (any) rows.push(obj);
    }

    return { columns: cols, rows };
  }

  function loadSheet(name){
    const ws = workbook.Sheets[name];
    const parsed = buildRowsFromWorksheet(ws);

    allRows = parsed.rows;
    columns = parsed.columns;

    els.search.disabled = false;
    els.topBtn.disabled = false;
    els.moreBtn.disabled = false;

    els.status.textContent = `Geladen: ${name}. Zeilen: ${allRows.length}.`;
    updateUI();
    startSearch("");
  }

  // === CSV (optional): minimal, ohne Sonderzeichen-Handling-Schalter ===
  // Falls du CSV nicht brauchst, kannst du den CSV-Teil einfach ignorieren.
  function detectDelimiter(text) {
    const sample = text.slice(0, 5000);
    const commas = (sample.match(/,/g) || []).length;
    const semis  = (sample.match(/;/g) || []).length;
    return semis > commas ? ";" : ",";
  }

  function parseCSV(text) {
    const delim = detectDelimiter(text);
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (inQuotes) {
        if (ch === '"' && next === '"') { cur += '"'; i++; }
        else if (ch === '"') inQuotes = false;
        else cur += ch;
        continue;
      }

      if (ch === '"') { inQuotes = true; continue; }
      if (ch === delim) { row.push(cur); cur = ""; continue; }

      if (ch === "\n") {
        row.push(cur); cur = "";
        if (row.some(cell => cell.trim() !== "")) rows.push(row);
        row = [];
        continue;
      }

      if (ch === "\r") continue;
      cur += ch;
    }

    if (cur.length || row.length) {
      row.push(cur);
      if (row.some(cell => cell.trim() !== "")) rows.push(row);
    }

    if (!rows.length) return { columns: [], rows: [] };

    const headers = rows[0].map(h => h.trim());
    const cols = headers.map((h, i) => h || `Spalte_${i + 1}`);

    const data = rows.slice(1).map(r => {
      const obj = {};
      for (let i = 0; i < cols.length; i++) obj[cols[i]] = r[i] ?? "";
      return obj;
    });

    return { columns: cols, rows: data };
  }

  // UI controls
  els.topBtn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });
  els.moreBtn.onclick = () => renderMore();

  let searchTimer = null;
  els.search.oninput = (e) => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => startSearch(e.target.value), 200);
  };

  els.sheetSelect.onchange = (e) => {
    const name = e.target.value;
    if (!name || name === "Sheet auswählen…") return;
    loadSheet(name);
  };

  els.file.onchange = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;

    els.status.textContent = "Lese Datei…";
    els.grid.innerHTML = "";
    els.footer.textContent = "";
    els.sheetSelect.innerHTML = "<option>Sheet auswählen…</option>";
    els.sheetSelect.disabled = true;
    els.search.disabled = true;
    els.moreBtn.disabled = true;
    els.topBtn.disabled = true;

    const lower = (f.name || "").toLowerCase();

    // CSV: schnell
    if (lower.endsWith(".csv")) {
      const text = await f.text();
      const parsed = parseCSV(text);

      allRows = parsed.rows;
      columns = parsed.columns;

      els.search.disabled = false;
      els.topBtn.disabled = false;
      els.moreBtn.disabled = false;

      els.status.textContent = `CSV geladen. Zeilen: ${allRows.length}.`;
      updateUI();
      startSearch("");
      return;
    }

    // XLSX: Hyperlinks werden über buildRowsFromWorksheet übernommen
    const buf = await f.arrayBuffer();
    workbook = XLSX.read(buf, { type: "array" });

    (workbook.SheetNames || []).forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      els.sheetSelect.appendChild(opt);
    });

    if (workbook.SheetNames.length === 1) {
      loadSheet(workbook.SheetNames[0]);
    } else {
      els.sheetSelect.disabled = false;
      els.status.textContent = "Sheet auswählen…";
    }
  };
</script>
</body>
</html>