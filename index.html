<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Spieleliste ‚Äì Build 6.6c</title>
  <style>
    :root{
      --bg: Canvas;
      --fg: CanvasText;
      --muted: color-mix(in oklab, var(--fg) 55%, var(--bg) 45%);
      --card: color-mix(in oklab, var(--bg) 92%, var(--fg) 8%);
      --border: color-mix(in oklab, var(--fg) 14%, var(--bg) 86%);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 24px;
      --chip: color-mix(in oklab, var(--bg) 90%, var(--fg) 10%);
      --chip2: color-mix(in oklab, var(--bg) 86%, var(--fg) 14%);
      --ok: #1f8f4a;
      --warn: #c59a00;
      --danger: #cc3b3b;
      --idblue: #2a6fdb;
      --idblue2: #1f57b5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 15% -10%, color-mix(in oklab, var(--idblue) 16%, var(--bg) 84%), transparent 60%),
                  radial-gradient(1000px 700px at 85% -5%, color-mix(in oklab, var(--warn) 16%, var(--bg) 84%), transparent 60%),
                  var(--bg);
      color:var(--fg);
      font: 16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
    }
    .wrap{max-width:900px;margin:0 auto;padding:16px 12px 80px}
    header{position:sticky;top:0;z-index:50;background:color-mix(in oklab, var(--bg) 88%, transparent);backdrop-filter: blur(10px);}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 12px;border-bottom:1px solid var(--border)}
    .title{
      font-weight:800;font-size:34px;letter-spacing:.2px
    }
    .build{opacity:.6;font-weight:700;margin-left:8px;font-size:18px}
    .searchRow{display:flex;gap:10px;align-items:center;flex:1;justify-content:flex-end}
    .search{
      width:min(340px, 42vw);
      border:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 94%, var(--fg) 6%);
      border-radius:999px;
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    .btn{
      border:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 92%, var(--fg) 8%);
      color:var(--fg);
      padding:12px 14px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btnIcon{width:44px;height:44px;display:grid;place-items:center;padding:0}
    .controls{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      padding:12px; border-bottom:1px solid var(--border);
    }
    .pill{
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 92%, var(--fg) 8%);
      font-weight:700;
    }
    .pill.ok{border-color: color-mix(in oklab, var(--ok) 55%, var(--border) 45%);}
    .pill.warn{border-color: color-mix(in oklab, var(--warn) 55%, var(--border) 45%);}
    .pill.bad{border-color: color-mix(in oklab, var(--danger) 55%, var(--border) 45%);}
    .select{
      border:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 94%, var(--fg) 6%);
      color:var(--fg);
      border-radius:999px;
      padding:10px 12px;
      font-weight:700;
    }
    .cards{padding:14px 10px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:16px;
      margin:12px 0;
    }
    .cardHead{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .name{font-weight:900;font-size:24px;margin:0 0 8px}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 10px}
    .chip{
      border:1px solid var(--border);
      background: var(--chip);
      padding:7px 10px;border-radius:999px;font-weight:800;
      display:inline-flex;gap:8px;align-items:center;
      max-width:100%;
    }
    .chip.id{
      background: color-mix(in oklab, var(--idblue) 22%, var(--bg) 78%);
      border-color: color-mix(in oklab, var(--idblue2) 55%, var(--border) 45%);
      color: color-mix(in oklab, var(--fg) 95%, var(--idblue) 5%);
    }
    .chip.mini{font-weight:750;opacity:.9}
    .chip.ok{background: color-mix(in oklab, var(--ok) 18%, var(--bg) 82%)}
    .chip.warn{background: color-mix(in oklab, var(--warn) 18%, var(--bg) 82%)}
    .chip.bad{background: color-mix(in oklab, var(--danger) 18%, var(--bg) 82%)}
    .grid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 12px;
      align-items:start;
      margin-top:10px;
    }
    .k{opacity:.7;font-weight:800}
    .v{font-weight:800}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .toggleRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .toggle{
      border:1px solid var(--border);
      background:color-mix(in oklab, var(--bg) 92%, var(--fg) 8%);
      border-radius: 14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      flex: 0 0 auto;
    }
    .toggle.small{padding:10px 12px;font-weight:850}
    .toggle[aria-expanded="true"]{background:color-mix(in oklab, var(--idblue) 12%, var(--bg) 88%); border-color: color-mix(in oklab, var(--idblue) 30%, var(--border) 70%)}
    .section{
      display:none;
      margin-top:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius: 16px;
      background: color-mix(in oklab, var(--bg) 94%, var(--fg) 6%);
    }
    .section.show{display:block}
    .section h4{margin:0 0 8px;font-size:14px;letter-spacing:.14em;text-transform:uppercase;opacity:.7}
    a{color: color-mix(in oklab, var(--idblue) 75%, var(--fg) 25%)}
    .muted{opacity:.75}
    .topBtn{
      position:fixed; right:14px; bottom:16px; z-index:60;
      border:1px solid var(--border);
      background: var(--card);
      border-radius:999px;
      padding:10px 14px;
      box-shadow: var(--shadow);
      font-weight:900;
      cursor:pointer;
    }
    dialog{
      border:1px solid var(--border);
      border-radius:24px;
      padding:0;
      background: var(--card);
      color:var(--fg);
      width:min(720px, calc(100vw - 18px));
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.35)}
    .dlgHead{display:flex;justify-content:space-between;align-items:center;padding:14px 14px;border-bottom:1px solid var(--border)}
    .dlgBody{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .check{display:inline-flex;gap:10px;align-items:center;border:1px solid var(--border);background:var(--chip);padding:10px 12px;border-radius:999px;font-weight:850}
    .check input{transform:scale(1.2)}
    .btnGhost{background:transparent;box-shadow:none}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="title">Spieleliste <span class="build">(Build 6.6c)</span></div>
    <div class="searchRow">
      <input id="search" class="search" type="search" placeholder="Suche‚Ä¶" disabled />
      <button id="btnMenu" class="btn btnIcon" type="button" disabled aria-haspopup="dialog" aria-controls="dlgMenu">‚ò∞</button>
    </div>
  </div>
  <div class="controls">
    <button id="btnLoad" class="btn" type="button">XLSX laden</button>
    <select id="sheet" class="select" disabled></select>
    <span id="pillHits" class="pill">Treffer: 0 ¬∑ angezeigt: 0/0</span>
    <span id="pillXlsx" class="pill warn">XLSX: ‚Ä¶</span>
    <span id="pillFile" class="pill">Datei: ‚Äî</span>
    <span id="pillJS" class="pill ok">JS: l√§uft</span>
    <button id="btnReset" class="btn" type="button" disabled>Reset</button>

    <!-- MUST NOT be disabled; hidden but clickable via btnLoad -->
    <input id="file" type="file" accept=".xlsx" style="position:absolute;left:-9999px;top:-9999px;width:1px;height:1px" />
  </div>
</header>

<div class="wrap">
  <div id="cards" class="cards"></div>
</div>

<button class="topBtn" id="btnTop" type="button" title="Nach oben">‚Üë Top</button>

<dialog id="dlgMenu">
  <div class="dlgHead">
    <div style="font-weight:900">Filter & Sort</div>
    <button id="btnCloseMenu" class="btn btnIcon btnGhost" type="button">‚úï</button>
  </div>
  <div class="dlgBody">
    <div class="row">
      <label class="k" for="sortField" style="min-width:90px">Sortierung</label>
      <select id="sortField" class="select"></select>
      <select id="sortDir" class="select">
        <option value="asc">Aufw√§rts</option>
        <option value="desc">Abw√§rts</option>
      </select>
    </div>

    <div class="row">
      <label class="k" style="min-width:90px">Filter</label>
      <label class="check"><input id="fFav" type="checkbox"> Favorit</label>
      <label class="check"><input id="fDel" type="checkbox"> Delisted</label>
    </div>

    <div class="row">
      <label class="k" style="min-width:90px">System</label>
      <label class="check"><input class="fSys" value="PS3" type="checkbox"> PS3</label>
      <label class="check"><input class="fSys" value="PS4" type="checkbox"> PS4</label>
      <label class="check"><input class="fSys" value="PS5" type="checkbox"> PS5</label>
      <label class="check"><input class="fSys" value="Vita" type="checkbox"> Vita</label>
    </div>

    <div class="row">
      <label class="k" style="min-width:90px">Quelle</label>
      <label class="check"><input class="fSrc" value="Digital" type="checkbox"> Digital</label>
      <label class="check"><input class="fSrc" value="PS Plus" type="checkbox"> PS Plus</label>
      <label class="check"><input class="fSrc" value="Retail-Disc" type="checkbox"> Retail-Disc</label>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="btnClear" class="btn" type="button">Filter l√∂schen</button>
      <button id="btnApply" class="btn" type="button">Anwenden</button>
    </div>
  </div>
</dialog>

<script src="./xlsx.full.min.js"></script>
<script>
(() => {
  "use strict";

  const BUILD = "6.6c";

  const el = {
    file: document.getElementById("file"),
    btnLoad: document.getElementById("btnLoad"),
    sheet: document.getElementById("sheet"),
    search: document.getElementById("search"),
    cards: document.getElementById("cards"),
    pillHits: document.getElementById("pillHits"),
    pillXlsx: document.getElementById("pillXlsx"),
    pillFile: document.getElementById("pillFile"),
    pillJS: document.getElementById("pillJS"),
    btnReset: document.getElementById("btnReset"),
    btnTop: document.getElementById("btnTop"),
    btnMenu: document.getElementById("btnMenu"),
    dlgMenu: document.getElementById("dlgMenu"),
    btnCloseMenu: document.getElementById("btnCloseMenu"),
    sortField: document.getElementById("sortField"),
    sortDir: document.getElementById("sortDir"),
    fFav: document.getElementById("fFav"),
    fDel: document.getElementById("fDel"),
    btnApply: document.getElementById("btnApply"),
    btnClear: document.getElementById("btnClear"),
  };

  const state = {
    rows: [],
    filtered: [],
    sheetName: "",
    fileName: "",
    sortField: "ID",
    sortDir: "asc",
    filters: { fav:false, del:false, sys: new Set(), src: new Set() },
    q: "",
    open: new Set(),           // card expanded ids
    openDesc: new Set(),
    openStore: new Set(),
    openTroph: new Set(),
    openHumor: new Set(),
  };

  function setPillXlsx(text, kind){
    el.pillXlsx.textContent = "XLSX: " + text;
    el.pillXlsx.classList.remove("ok","warn","bad");
    el.pillXlsx.classList.add(kind);
  }

  function nowHHMMSS(){
    const d = new Date();
    return d.toTimeString().slice(0,8);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function norm(s){
    return String(s ?? "").toLowerCase().normalize("NFKD");
  }

  function splitPlatforms(s){
    // Returns array of tokens like ["PS4","PS5","Vita","PS3"] from strings like "PS4, PS5"
    const t = String(s ?? "").replaceAll("PS Vita","Vita");
    const items = t.split(/[,/]/).map(x => x.trim()).filter(Boolean);
    // Keep canonical order:
    const order = ["PS3","PS4","PS5","Vita"];
    const set = new Set(items.map(x => x === "PSVita" ? "Vita" : x));
    return order.filter(x => set.has(x));
  }

  function parsePlatformBlocks(s){
    // Input looks like:
    // "PS4\n18 of 18\n\nPS5\n17 of 18"
    // Returns {PS4:"18 of 18", PS5:"17 of 18"}
    const out = {};
    const txt = String(s ?? "").trim();
    if (!txt) return out;
    const parts = txt.split(/\n\s*\n/).map(p => p.trim()).filter(Boolean);
    for (const part of parts){
      const lines = part.split("\n").map(x => x.trim()).filter(Boolean);
      if (!lines.length) continue;
      const plat = lines[0];
      const val = lines.slice(1).join(" ").trim();
      if (plat) out[plat] = val || "";
    }
    return out;
  }

  function trophyStatusForPlatform(plat, p100, pplatin, pprog){
    // Determine icon/text based on best available evidence
    const pl = (pplatin?.[plat] ?? "").toLowerCase();
    const h = (p100?.[plat] ?? "").toLowerCase();
    const prog = (pprog?.[plat] ?? "").toLowerCase();

    if (pl.includes("platinum")) return {icon:"üíé", text:"Platin erlangt", cls:"ok"};
    if (pl.includes("no-platinum")) return {icon:"‚Äî", text:"Kein Platin", cls:"warn"};
    if (h.includes("completed")) return {icon:"‚úÖ", text:"100% erreicht", cls:"ok"};
    if (h.includes("in progress") || prog.includes("of")) return {icon:"‚è≥Ô∏è", text:"In Arbeit", cls:"warn"};
    return {icon:"üí§", text:"Ungespielt", cls:""};
  }

  function firstLine(s){
    const t = String(s ?? "").trim();
    if (!t) return "";
    return t.split(/\r?\n/)[0].trim();
  }

  function getRowValue(row, key){
    return row[key] ?? "";
  }

  function buildSearchHaystack(row){
    const fields = ["Spieletitel","Genre","Subgenre","Entwickler","Kurzbeschreibung","System"];
    return fields.map(f => String(row[f] ?? "")).join(" | ");
  }

  function applyAll(){
    const q = norm(state.q);
    const rows = state.rows.filter(r => {
      if (q){
        if (!norm(buildSearchHaystack(r)).includes(q)) return false;
      }
      if (state.filters.fav && String(r["Favorit"] ?? "").trim().toLowerCase() !== "x") return false;
      if (state.filters.del){
        const v = String(r["Verf√ºgbarkeit"] ?? "").toLowerCase();
        if (!v.includes("delisted") && !v.includes("nicht mehr")) return false;
      }
      if (state.filters.sys.size){
        const plats = splitPlatforms(r["System"]);
        const hit = plats.some(p => state.filters.sys.has(p));
        if (!hit) return false;
      }
      if (state.filters.src.size){
        const src = String(r["Quelle"] ?? "").trim();
        if (!state.filters.src.has(src)) return false;
      }
      return true;
    });

    const sf = state.sortField;
    const dir = state.sortDir === "desc" ? -1 : 1;
    rows.sort((a,b) => {
      const va = a[sf], vb = b[sf];
      // numeric if both numeric-ish
      const na = Number(String(va).replace(",", "."));
      const nb = Number(String(vb).replace(",", "."));
      const bothNum = !Number.isNaN(na) && !Number.isNaN(nb) && String(va).trim() !== "" && String(vb).trim() !== "";
      if (bothNum) return (na - nb) * dir;
      return String(va ?? "").localeCompare(String(vb ?? ""), "de", {numeric:true, sensitivity:"base"}) * dir;
    });

    state.filtered = rows;
    render();
  }

  function render(){
    const total = state.rows.length;
    const shown = Math.min(40, state.filtered.length);
    el.pillHits.textContent = `Treffer: ${state.filtered.length} ¬∑ angezeigt: ${shown}/${total}`;

    const slice = state.filtered.slice(0, shown);
    el.cards.innerHTML = slice.map(r => renderCard(r)).join("");

    // Bind toggles (event delegation)
    el.cards.querySelectorAll("[data-toggle]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const id = btn.getAttribute("data-id");
        const kind = btn.getAttribute("data-toggle");
        toggleSection(id, kind);
      });
    });

    el.cards.querySelectorAll("a[data-store]").forEach(a => {
      a.addEventListener("click", (e) => e.stopPropagation());
    });
  }

  function toggleSetFor(kind){
    if (kind === "details") return state.open;
    if (kind === "desc") return state.openDesc;
    if (kind === "store") return state.openStore;
    if (kind === "troph") return state.openTroph;
    if (kind === "humor") return state.openHumor;
    return state.open;
  }

  function toggleSection(id, kind){
    const set = toggleSetFor(kind);
    if (set.has(id)) set.delete(id); else set.add(id);
    // Update only this card to keep it snappy
    const card = el.cards.querySelector(`[data-card="${CSS.escape(id)}"]`);
    if (!card) { render(); return; }

    const btn = card.querySelector(`[data-toggle="${kind}"]`);
    const sec = card.querySelector(`[data-sec="${kind}"]`);
    if (btn) btn.setAttribute("aria-expanded", set.has(id) ? "true" : "false");
    if (sec) sec.classList.toggle("show", set.has(id));

    // Update button labels (anzeigen/verbergen)
    if (btn){
      const map = {details:["Mehr Details","Weniger Details"], desc:["Beschreibung anzeigen","Beschreibung verbergen"], store:["Store anzeigen","Store verbergen"], troph:["Troph√§en anzeigen","Troph√§en verbergen"], humor:["Humorstatistik anzeigen","Humorstatistik verbergen"]};
      const labels = map[kind] || ["Anzeigen","Verbergen"];
      btn.textContent = set.has(id) ? labels[1] : labels[0];
    }
  }

  function renderCard(r){
    const id = String(r["ID"] ?? "").trim() || "‚Äî";
    const title = String(r["Spieletitel"] ?? "").trim() || "‚Äî";
    const fav = String(r["Favorit"] ?? "").trim().toLowerCase() === "x";
    const avail = String(r["Verf√ºgbarkeit"] ?? "").trim();
    const isDel = /delisted|nicht mehr/i.test(avail);
    const system = splitPlatforms(r["System"]);
    const source = String(r["Quelle"] ?? "").trim();
    const genre = String(r["Genre"] ?? "").trim();
    const sub = String(r["Subgenre"] ?? "").trim();
    const dev = String(r["Entwickler"] ?? "").trim();
    const main = String(r["Spielzeit (Main)"] ?? "").trim();
    const hundred = String(r["Spielzeit (100%)"] ?? "").trim();
    const meta = String(r["Metascore"] ?? "").trim();
    const user = String(r["Userwertung"] ?? "").trim();
    const desc = String(r["Kurzbeschreibung"] ?? "").trim();
    const storeText = String(r["Store Link"] ?? "").trim();
    const storeHref = String(r["__storeHref"] ?? "").trim();

    const pProg = parsePlatformBlocks(r["Troph√§en Fortschritt"]);
    const p100 = parsePlatformBlocks(r["100%"]);
    const pPlat = parsePlatformBlocks(r["Platin"]);

    // overall status = best across systems
    let best = {rank:0, icon:"üí§", text:"Ungespielt", cls:""};
    const rankOf = (t) => t.icon==="üíé"?4 : t.icon==="‚úÖ"?3 : t.icon==="‚è≥Ô∏è"?2 : t.icon==="‚Äî"?1 : 0;
    for (const plat of (system.length ? system : ["PS4","PS5","PS3","Vita"])){
      const st = trophyStatusForPlatform(plat, p100, pPlat, pProg);
      const rk = rankOf(st);
      if (rk > best.rank) best = {rank:rk, ...st};
    }

    const openDetails = state.open.has(id);
    const openDesc = state.openDesc.has(id);
    const openStore = state.openStore.has(id);
    const openTroph = state.openTroph.has(id);
    const openHumor = state.openHumor.has(id);

    const chips = [
      `<span class="chip id">ID ${escapeHtml(id)}</span>`,
      ...system.map(p => `<span class="chip mini">${escapeHtml(p)}</span>`),
      avail ? `<span class="chip mini ${isDel?'bad':''}">${escapeHtml(avail)}</span>` : "",
      fav ? `<span class="chip mini ok">‚≠ê Favorit</span>` : "",
      best.text ? `<span class="chip ${best.cls}">${escapeHtml(best.icon)} ${escapeHtml(best.text)}</span>` : ""
    ].filter(Boolean).join("");

    const compactGrid = `
      <div class="grid">
        <div class="k">Genre</div><div class="v">${escapeHtml(genre || "‚Äî")}</div>
        <div class="k">Entwickler</div><div class="v">${escapeHtml(dev || "‚Äî")}</div>
        <div class="k">Spielzeit</div><div class="v">${escapeHtml((main||"‚Äî") + "h / " + (hundred||"‚Äî") + "h")}</div>
        <div class="k">Metascore</div><div class="v">${escapeHtml(meta || "‚Äî")}</div>
        <div class="k">Userwertung</div><div class="v">${escapeHtml(user || "‚Äî")}</div>
      </div>
    `;

    const detailsGrid = `
      <div class="hr"></div>
      <div class="grid">
        <div class="k">Subgenre</div><div class="v">${escapeHtml(sub || "‚Äî")}</div>
      </div>
      <div class="toggleRow">
        <button class="toggle small" data-toggle="desc" data-id="${escapeHtml(id)}" aria-expanded="${openDesc}">${openDesc ? "Beschreibung verbergen" : "Beschreibung anzeigen"}</button>
        <button class="toggle small" data-toggle="store" data-id="${escapeHtml(id)}" aria-expanded="${openStore}">${openStore ? "Store verbergen" : "Store anzeigen"}</button>
        <button class="toggle small" data-toggle="troph" data-id="${escapeHtml(id)}" aria-expanded="${openTroph}">${openTroph ? "Troph√§en verbergen" : "Troph√§en anzeigen"}</button>
        <button class="toggle small" data-toggle="humor" data-id="${escapeHtml(id)}" aria-expanded="${openHumor}">${openHumor ? "Humorstatistik verbergen" : "Humorstatistik anzeigen"}</button>
      </div>

      <div class="section ${openDesc?"show":""}" data-sec="desc">
        <h4>Beschreibung</h4>
        <div class="v" style="font-weight:800;white-space:pre-wrap">${escapeHtml(desc || "‚Äî")}</div>
      </div>

      <div class="section ${openStore?"show":""}" data-sec="store">
        <h4>Store</h4>
        <div class="grid" style="grid-template-columns:120px 1fr">
          <div class="k">Quelle</div><div class="v">${escapeHtml(source || "‚Äî")}</div>
          <div class="k">Store</div><div class="v">${
            storeHref ? `<a data-store href="${escapeHtml(storeHref)}" target="_blank" rel="noopener">Store Link</a>` :
            (storeText && /^https?:\/\//i.test(storeText) ? `<a data-store href="${escapeHtml(storeText)}" target="_blank" rel="noopener">Store Link</a>` : `<span class="muted">‚Äî</span>`)
          }</div>
          <div class="k">Verf√ºgbarkeit</div><div class="v">${escapeHtml(avail || "‚Äî")}</div>
        </div>
      </div>

      <div class="section ${openTroph?"show":""}" data-sec="troph">
        <h4>Troph√§en</h4>
        ${renderTrophSection(system, pProg, p100, pPlat)}
      </div>

      <div class="section ${openHumor?"show":""}" data-sec="humor">
        <h4>Humorstatistik</h4>
        <div class="grid" style="grid-template-columns:160px 1fr">
          <div class="k">Gesamtstunden</div><div class="v">${escapeHtml(String(r["Gesamtstunden (Humorstatistik)"] ?? "‚Äî"))}</div>
          <div class="k">% Lebenszeit</div><div class="v">${escapeHtml(String(r["% Lebenszeit (Humorstatistik)"] ?? "‚Äî"))}</div>
          <div class="k">Jahre</div><div class="v">${escapeHtml(String(r["Jahre (Humorstatistik)"] ?? "‚Äî"))}</div>
        </div>
      </div>
    `;

    return `
      <div class="card" data-card="${escapeHtml(id)}">
        <div class="cardHead">
          <div style="min-width:0">
            <div class="name">${escapeHtml(title)}</div>
            <div class="badges">${chips}</div>
          </div>
        </div>

        ${compactGrid}

        <div class="toggleRow">
          <button class="toggle" data-toggle="details" data-id="${escapeHtml(id)}" aria-expanded="${openDetails}">${openDetails ? "Weniger Details" : "Mehr Details"}</button>
        </div>

        <div class="section ${openDetails?"show":""}" data-sec="details">
          ${detailsGrid}
        </div>
      </div>
    `;
  }

  function renderTrophSection(system, pProg, p100, pPlat){
    const plats = system.length ? system : ["PS4","PS5","PS3","Vita"];
    const parts = plats.map(plat => {
      const prog = pProg?.[plat] ?? "";
      const st100 = p100?.[plat] ?? "";
      const stpl = pPlat?.[plat] ?? "";
      const st = trophyStatusForPlatform(plat, p100, pPlat, pProg);
      const pct = pctFromProgress(prog);
      return `
        <div class="grid" style="grid-template-columns:80px 1fr">
          <div class="chip mini">${escapeHtml(plat)}</div>
          <div>
            ${pct !== null ? renderBar(pct) : `<div class="muted">‚Äî</div>`}
            <div class="badges" style="margin-top:8px">
              <span class="chip ${st.cls}">${escapeHtml(st.icon)} ${escapeHtml(st.text)}</span>
              ${stpl && stpl.toLowerCase().includes("no-platinum") ? `<span class="chip warn">‚Äî Kein Platin</span>` : ""}
            </div>
            ${prog ? `<div class="muted" style="font-weight:800">${escapeHtml(prog)}</div>` : ""}
          </div>
        </div>
        <div class="hr"></div>
      `;
    }).join("");
    return parts || `<div class="muted">‚Äî</div>`;
  }

  function pctFromProgress(s){
    // "17 of 18" -> 94
    const m = String(s ?? "").match(/(\d+)\s*of\s*(\d+)/i);
    if (!m) return null;
    const a = Number(m[1]), b = Number(m[2]);
    if (!b) return null;
    return Math.max(0, Math.min(100, Math.round((a/b)*100)));
  }

  function renderBar(pct){
    const w = Math.max(0, Math.min(100, pct));
    return `
      <div style="display:flex;justify-content:space-between;font-weight:900;opacity:.85">
        <span>${w}%</span><span></span>
      </div>
      <div style="height:10px;border-radius:999px;border:1px solid var(--border);background:color-mix(in oklab, var(--bg) 88%, var(--fg) 12%);overflow:hidden">
        <div style="height:100%;width:${w}%;background:color-mix(in oklab, var(--fg) 40%, var(--bg) 60%)"></div>
      </div>
    `;
  }

  function enableUI(){
    el.search.disabled = false;
    el.btnMenu.disabled = false;
    el.sheet.disabled = false;
    el.btnReset.disabled = false;
  }

  function resetAll(){
    state.rows = [];
    state.filtered = [];
    state.sheetName = "";
    state.fileName = "";
    state.q = "";
    state.filters = { fav:false, del:false, sys:new Set(), src:new Set() };
    state.open.clear(); state.openDesc.clear(); state.openStore.clear(); state.openTroph.clear(); state.openHumor.clear();
    el.search.value = "";
    el.cards.innerHTML = "";
    el.sheet.innerHTML = "";
    el.search.disabled = true;
    el.btnMenu.disabled = true;
    el.sheet.disabled = true;
    el.btnReset.disabled = true;
    el.pillHits.textContent = "Treffer: 0 ¬∑ angezeigt: 0/0";
    el.pillFile.textContent = "Datei: ‚Äî";
    setPillXlsx("‚Ä¶", "warn");
  }

  async function loadXlsxFile(file){
    if (!window.XLSX){
      setPillXlsx("FEHLT", "bad");
      alert("XLSX-Library fehlt. Lege xlsx.full.min.js neben index.html (gleiches Verzeichnis).");
      return;
    }
    try{
      setPillXlsx("lade‚Ä¶", "warn");
      el.pillFile.textContent = `Datei: ${file.name} (${Math.round(file.size/1024)} KB)`;
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, {type:"array", cellText:true, cellDates:true});
      const sheetNames = wb.SheetNames || [];
      if (!sheetNames.length){
        setPillXlsx("leer?", "bad");
        return;
      }
      // default sheet: Spieleliste Komplett if exists
      const preferred = sheetNames.includes("Spieleliste Komplett") ? "Spieleliste Komplett" : sheetNames[0];
      state.fileName = file.name;

      // populate sheet select
      el.sheet.innerHTML = sheetNames.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
      el.sheet.value = preferred;
      state.sheetName = preferred;

      // build sortField options from headers after reading preferred sheet once
      const rows = sheetToRows(wb.Sheets[preferred], wb, preferred);
      state.rows = rows;
      state.filtered = rows.slice();
      setPillXlsx("ok (lokal)", "ok");

      fillSortFields(rows);
      enableUI();
      applyAll();

    }catch(err){
      console.error(err);
      setPillXlsx("Fehler", "bad");
      alert("Fehler beim Einlesen der XLSX: " + (err?.message || err));
    }
  }

  function fillSortFields(rows){
    const keys = rows.length ? Object.keys(rows[0]) : ["ID","Spieletitel","Genre","Entwickler","Metascore","Userwertung"];
    const preferred = ["ID","Spieletitel","Genre","Metascore","Userwertung","Spielzeit (Main)"];
    const ordered = [...new Set([...preferred, ...keys])].filter(k => !k.startsWith("__"));
    el.sortField.innerHTML = ordered.map(k => `<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join("");
    if (ordered.includes(state.sortField)) el.sortField.value = state.sortField;
    else { state.sortField = ordered[0]; el.sortField.value = ordered[0]; }
  }

  function sheetToRows(sheet, wb, sheetName){
    // Use first row as headers, then build objects.
    // Also attempt to extract hyperlinks from "Store Link" column.
    const range = XLSX.utils.decode_range(sheet["!ref"]);
    const headers = [];
    for (let c=range.s.c; c<=range.e.c; c++){
      const addr = XLSX.utils.encode_cell({r:range.s.r, c});
      const cell = sheet[addr];
      headers.push(String(cell?.v ?? "").trim());
    }
    // Identify Store Link column index
    const storeCol = headers.findIndex(h => h === "Store Link");

    const out = [];
    for (let r=range.s.r+1; r<=range.e.r; r++){
      const row = {};
      let empty = true;
      for (let c=range.s.c; c<=range.e.c; c++){
        const key = headers[c - range.s.c] || `C${c}`;
        if (!key) continue;
        const addr = XLSX.utils.encode_cell({r, c});
        const cell = sheet[addr];
        const v = cell ? (cell.w ?? cell.v ?? "") : "";
        if (String(v).trim() !== "") empty = false;
        row[key] = v;
        // hyperlink
        if (c - range.s.c === storeCol && cell && cell.l && (cell.l.Target || cell.l.target)){
          row["__storeHref"] = String(cell.l.Target || cell.l.target);
        }
      }
      // skip fully empty rows
      const id = String(row["ID"] ?? "").trim();
      if (empty || id === "") continue;
      out.push(row);
    }
    return out;
  }

  // --- UI Wiring ---
  el.btnLoad.addEventListener("click", () => {
    // Always open file picker (file input is NEVER disabled)
    el.file.value = "";
    el.file.click();
  });

  el.file.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    loadXlsxFile(file);
  });

  el.sheet.addEventListener("change", () => {
    // If workbook reload is needed we would keep wb in memory; for simplicity, require reload via file for now.
    // But we can still filter/sort current rows; sheet switching is disabled until we add multi-sheet cache.
    // Keep: no-op for now.
  });

  el.search.addEventListener("input", () => {
    state.q = el.search.value || "";
    applyAll();
  });

  el.btnReset.addEventListener("click", resetAll);

  el.btnTop.addEventListener("click", () => window.scrollTo({top:0, behavior:"smooth"}));

  el.btnMenu.addEventListener("click", () => {
    // sync current filters into dialog controls
    el.fFav.checked = !!state.filters.fav;
    el.fDel.checked = !!state.filters.del;
    document.querySelectorAll(".fSys").forEach(cb => cb.checked = state.filters.sys.has(cb.value));
    document.querySelectorAll(".fSrc").forEach(cb => cb.checked = state.filters.src.has(cb.value));
    el.sortField.value = state.sortField;
    el.sortDir.value = state.sortDir;
    el.dlgMenu.showModal();
  });

  el.btnCloseMenu.addEventListener("click", () => el.dlgMenu.close());

  el.btnApply.addEventListener("click", () => {
    state.filters.fav = el.fFav.checked;
    state.filters.del = el.fDel.checked;
    state.filters.sys = new Set(Array.from(document.querySelectorAll(".fSys")).filter(cb => cb.checked).map(cb => cb.value));
    state.filters.src = new Set(Array.from(document.querySelectorAll(".fSrc")).filter(cb => cb.checked).map(cb => cb.value));
    state.sortField = el.sortField.value;
    state.sortDir = el.sortDir.value;
    el.dlgMenu.close();
    applyAll();
  });

  el.btnClear.addEventListener("click", () => {
    el.fFav.checked = false;
    el.fDel.checked = false;
    document.querySelectorAll(".fSys").forEach(cb => cb.checked = false);
    document.querySelectorAll(".fSrc").forEach(cb => cb.checked = false);
  });

  // init
  resetAll();
  // JS pill shows time to confirm runtime if needed
  el.pillJS.textContent = "JS: l√§uft (" + nowHHMMSS() + ")";
})();
</script>
</body>
</html>
