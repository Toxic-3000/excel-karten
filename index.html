<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Spieleliste (Build 6.6h)</title>
  <style>
    :root {
      --bg: Canvas;
      --fg: CanvasText;
      --muted: color-mix(in oklab, CanvasText 55%, Canvas 45%);
      --card: color-mix(in oklab, Canvas 92%, CanvasText 8%);
      --border: color-mix(in oklab, CanvasText 14%, Canvas 86%);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 24px;
      --chip: color-mix(in oklab, Canvas 88%, CanvasText 12%);
      --chip2: color-mix(in oklab, Canvas 82%, CanvasText 18%);
      --ok: #1f8f4a;
      --warn: #c59a00;
      --danger: #cc3b3b;
      --accent: color-mix(in oklab, #2a6fdb 60%, CanvasText 40%);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a { color: var(--accent); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px 14px 90px; }
    header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }
    .title {
      font-size: 38px;
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.05;
    }
    .title small { font-weight: 700; color: var(--muted); }
    .search {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 12px 14px;
      background: var(--card);
      color: var(--fg);
      font-size: 16px;
      outline: none;
    }
    .btnIcon {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 999px;
      width: 46px;
      height: 46px;
      display: grid;
      place-items: center;
      box-shadow: var(--shadow);
    }
    .btnIcon:active { transform: translateY(1px); }
    .controls {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 6px;
    }
    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      box-shadow: var(--shadow);
      cursor: pointer;
      user-select: none;
      color: var(--fg);
    }
    .btn:active { transform: translateY(1px); }
    select {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
      border-radius: 999px;
      padding: 12px 14px;
      font-weight: 650;
      box-shadow: var(--shadow);
      width: 100%;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 14px;
    }
    .chip {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      box-shadow: var(--shadow);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }
    .chip strong { font-variant-numeric: tabular-nums; }
    .grid {
      display: grid;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .cardHeader {
      display: grid;
      gap: 10px;
    }
    /* Titelzeile: ID-Badge links neben dem Titel, optional Favorit rechts */
    .titleLine{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .cardTitleText{
      flex:1 1 auto;
      min-width: 180px;
      line-height: 1.1;
    }
    .titleLine .pill{
      margin: 0;
    }

    /* Die neuen Reihen unter dem Titel */
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 8px;
    }
    .pillRow:first-of-type{ margin-top: 0; }

    .pill.source{ background: var(--chip2); }
    .pill.fav{ background: color-mix(in oklab, var(--ok) 22%, var(--chip) 78%); }
    .pill {
      background: var(--chip2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 750;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .pill.id { background: color-mix(in oklab, #7aa7ff 28%, var(--chip2) 72%); }
    .pill.ok { background: color-mix(in oklab, var(--ok) 18%, var(--chip2) 82%); }
    .pill.warn { background: color-mix(in oklab, var(--warn) 18%, var(--chip2) 82%); }
    .pill.danger { background: color-mix(in oklab, var(--danger) 18%, var(--chip2) 82%); }
    .kv {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 12px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 14px;
    }
    .k { color: var(--muted); font-weight: 700; }
    .v { font-weight: 800; }
    details {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
    }
    summary {
      list-style: none;
      cursor: pointer;
      font-weight: 900;
      font-size: 18px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    summary::-webkit-details-marker { display:none; }
    .chev {
      width: 22px; height: 22px;
      border-radius: 999px;
      display: grid; place-items: center;
      border: 1px solid var(--border);
      background: var(--chip);
      flex: 0 0 auto;
    }
    details[open] .chev { transform: rotate(180deg); }
    .subdetails {
      margin-top: 8px;
      padding-top: 8px;
    }
    .subdetails summary { font-size: 16px; font-weight: 850; }
    .text {
      margin: 10px 0 0;
      color: var(--fg);
      font-size: 14.5px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    .table td {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .table td:first-child { color: var(--muted); font-weight: 750; width: 38%; padding-right: 10px; }
    .floatingTop {
      position: fixed;
      right: 14px;
      bottom: 18px;
      z-index: 60;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      font-weight: 800;
      text-decoration: none;
      color: var(--fg);
      display: none;
    }
    .floatingTop.show { display: inline-flex; }
    /* Bottom sheet */
    .overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease;
  z-index: 80;
  display: none;
}
.overlay.open{ opacity: 1; pointer-events: auto; }

    .overlay.open { display: block; }
    .sheet{
  position: fixed;
  left: 12px; right: 12px;
  bottom: -110%;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 22px;
  box-shadow: var(--shadow);
  padding: 16px;
  z-index: 90;
  transition: bottom .22s ease;
  max-height: min(85vh, calc(100vh - 24px));
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
}
.sheet.open{ bottom: 12px; }

    .sheet.open { bottom: 0; }
    .sheetHead{
  display:flex; align-items:center; justify-content:space-between;
  gap: 12px;
  position: sticky;
  top: 0;
  background: var(--card);
  z-index: 2;
  padding: 10px 0 12px;
  margin: -16px -16px 12px;
  padding-left: 16px;
  padding-right: 16px;
  border-bottom: 1px solid var(--border);
}

    .sheetHead h2 { margin: 0; font-size: 22px; font-weight: 900; }
    .sheetClose {
      border: 1px solid var(--border);
      background: var(--chip);
      border-radius: 999px;
      width: 44px; height: 44px;
      display: grid; place-items: center;
      font-weight: 900;
      cursor: pointer;
      color: var(--fg);
    }
    .sheetGrid {
      display: grid;
      gap: 12px;
      margin-top: 12px;
      padding-top: 10px; /* Abstand unter Sticky-Header (verhindert √úberdeckung von "SORTIEREN") */
    
      padding-top: 10px; /* Abstand unter Sticky-Header (verhindert √úberdeckung) */
    }
    .sheetGrid label {
      display: grid;
      gap: 8px;
      font-weight: 800;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 12px;
    }
    .sheetActions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    .note {
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    @media (max-width: 520px) {
      .title { font-size: 34px; }
      .kv { grid-template-columns: 110px 1fr; }
    }
  .noScroll{overflow:hidden; touch-action:none;}
</style>
  <script src="./xlsx.full.min.js"></script>
</head>
<body>
<a id="top"></a>
<div class="wrap">
  <header>
    <div class="title">Spieleliste <small>(Build 6.6f)</small></div>
    <input id="q" class="search" type="search" placeholder="Suche..." disabled />
    <button id="btnMenu" class="btnIcon" type="button" aria-label="Filter & Sort">
      ‚ò∞
    </button>
  </header>

  <div class="controls">
    <button id="btnLoad" class="btn" type="button">XLSX laden</button>
    <select id="selSheet" disabled></select>
  </div>

  <div class="chips" id="statusChips">
    <span class="chip">Treffer: <strong id="hitCount">0</strong> ¬∑ angezeigt: <strong id="shownCount">0</strong>/<strong id="totalCount">0</strong></span>
    <span class="chip" id="chipXlsx">XLSX: <strong id="xlsxState">‚Ä¶</strong></span>
    <span class="chip">Datei: <strong id="fileState">‚Äî</strong></span>
    <span class="chip">JS: <strong id="jsUptime">‚Ä¶</strong></span>
    <button id="btnReset" class="btn" type="button" style="padding:10px 14px; font-weight:900;">Reset</button>
  </div>

  <div class="chips" id="summaryChips" style="display:none;"></div>

  <div class="grid" id="list"></div>

  <div class="note" id="note">
    Hinweis: Die Excel wird lokal im Browser gelesen (keine Uploads). Wenn du Probleme hast, pr√ºfe, ob <code>xlsx.full.min.js</code> neben <code>index.html</code> liegt.
  </div>
</div>

<a class="floatingTop" id="btnTop" href="#top">‚Üë Top</a>

<div class="overlay" id="overlay"></div>
<section class="sheet" id="sheet" aria-modal="true" role="dialog" aria-label="Filter & Sortieren">
  <div class="sheetHead">
    <h2>Filter &amp; Sortieren</h2>
    <button class="sheetClose" id="sheetClose" type="button">√ó</button>
  </div>

  <div class="sheetGrid">
    <label>SORTIEREN
      <select id="sortBy">
        <option value="id">ID</option>
        <option value="title">Spieletitel</option>
        <option value="genre">Genre</option>
        <option value="meta">Metascore</option>
        <option value="user">Userwertung</option>
        <option value="main">Spielzeit (Main)</option>
        <option value="fav">Favorit</option>
      </select>
    </label>

    <label>RICHTUNG
      <select id="sortDir">
        <option value="asc">Aufw√§rts</option>
        <option value="desc">Abw√§rts</option>
      </select>
    </label>

    <label>PLATTFORM
      <select id="fSystem">
        <option value="">Alle</option>
        <option value="PS3">PS3</option>
        <option value="PS4">PS4</option>
        <option value="PS5">PS5</option>
        <option value="Vita">Vita</option>
      </select>
    </label>

    <label>QUELLE
      <select id="fQuelle">
        <option value="">Alle</option>
        <option value="Digital">Digital</option>
        <option value="PS Plus">PS Plus</option>
        <option value="Retail-Disc">Retail-Disc</option>
      </select>
    </label>

    <label>VERF√úGBARKEIT
      <select id="fAvail">
        <option value="">Alle</option>
        <option value="Verf√ºgbar">Verf√ºgbar</option>
        <option value="Delisted">Delisted</option>
      </select>
    </label>

    <label>FAVORIT
      <select id="fFav">
        <option value="">Alle</option>
        <option value="only">Nur Favoriten</option>
        <option value="no">Ohne Favoriten</option>
      </select>
    </label>

    <label>TROPH√ÑEN
      <select id="fTrophy">
        <option value="">Alle</option>
        <option value="platinum">Platin erlangt</option>
        <option value="no-platinum">Kein Platin</option>
        <option value="in-progress">In Arbeit</option>
        <option value="completed">100% erreicht</option>
        <option value="unplayed">Ungespielt</option>
      </select>
    </label>
  </div>

  <div class="sheetActions">
    <button id="btnClearFilters" class="btn" type="button">Filter zur√ºcksetzen</button>
    <button id="btnApply" class="btn" type="button">Anwenden</button>
  </div>

  <div class="note">
    Trophy-Parsing nutzt 3 Spalten: ‚ÄûTroph√§en Fortschritt‚Äú, ‚Äû100%‚Äú, ‚ÄûPlatin‚Äú.
  </div>
</section>

<input id="file" type="file" accept=".xlsx,.xls" style="display:none" />

<script>
(() => {
  const t0 = Date.now();
  const $ = (id) => document.getElementById(id);

  const elQ = $("q");
  const elList = $("list");
  const elSheet = $("selSheet");
  const elFile = $("file");
  const elHit = $("hitCount");
  const elShown = $("shownCount");
  const elTotal = $("totalCount");
  const elXlsxState = $("xlsxState");
  const elFileState = $("fileState");
  const elUptime = $("jsUptime");
  const elSummary = $("summaryChips");

  const overlay = $("overlay");
  const sheet = $("sheet");

  const state = {
    wb: null,
    rows: [],
    filtered: [],
    renderCount: 40,
    search: "",
    sortBy: "id",
    sortDir: "asc",
    fSystem: "",
    fQuelle: "",
    fAvail: "",
    fFav: "",
    fTrophy: ""
  };

  function fmtTime(ms) {
    const s = Math.floor(ms/1000);
    const hh = String(Math.floor(s/3600)).padStart(2,"0");
    const mm = String(Math.floor((s%3600)/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${hh}:${mm}:${ss}`;
  }

  function setXlsxState() {
    const ok = !!window.XLSX;
    elXlsxState.textContent = ok ? "ok" : "FEHLT";
    $("chipXlsx").style.borderColor = ok ? "color-mix(in oklab, var(--ok) 45%, var(--border) 55%)"
                                        : "color-mix(in oklab, var(--danger) 45%, var(--border) 55%)";
    $("btnLoad").disabled = !ok;
    elQ.disabled = !ok;
    elSheet.disabled = !ok;
  }

  function safeStr(v) {
    if (v === null || v === undefined) return "";
    return String(v).replace(/\s+/g," ").trim();
  }

  function pick(obj, keys) {
    for (const k of keys) {
      if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
    }
    return "";
  }

  function parseSystems(row) {
    // "System" kann mehrere Werte enthalten ("PS4, Vita" oder "PS4 / PS5" etc.)
    const raw = safeStr(pick(row, ["System", "Plattform", "Plattformen"]));
    if (!raw) return [];
    return raw.split(/[,/]|\s\+\s/).map(s => safeStr(s)).filter(Boolean);
  }

  function parseQuelle(row) {
    return safeStr(pick(row, ["Quelle", "Medium", "Lizenz"]));
  }

  function parseAvail(row) {
    return safeStr(pick(row, ["Verf√ºgbarkeit", "Availability"]));
  }

  function parseFav(row) {
    const v = pick(row, ["Favorit", "Favorite"]);
    const s = safeStr(v).toLowerCase();
    return s === "1" || s === "true" || s === "ja" || s === "yes" || s === "‚òÖ" || s === "fav" || s === "favorit";
  }

  function parseNum(val) {
    if (val === null || val === undefined) return NaN;
    if (typeof val === "number") return val;
    const s = String(val).replace(",", ".").replace(/[^0-9.\-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function trophyInfo(row) {
    const prog = safeStr(row["Troph√§en Fortschritt"]);
    const c100 = safeStr(row["100%"]);
    const plat = safeStr(row["Platin"]);
    let pct = null;
    // Beispiele: "PS4\n18%", "VITA\n0%"
    const m = prog.match(/(\d{1,3})\s*%/);
    if (m) pct = Math.max(0, Math.min(100, parseInt(m[1],10)));
    const hasPlat = /platinum/i.test(plat);
    const has100 = /completed/i.test(c100);
    const unplayed = /no\-trophies/i.test(prog) || pct === 0 || pct === null;
    const inProgress = (pct !== null && pct > 0 && pct < 100) || (/in\s*progress/i.test(prog));
    return { pct, hasPlat, has100, unplayed, inProgress };
  }

  function normalizeRow(row) {
    const id = parseInt(pick(row, ["ID","Id","id"]), 10);
    const title = safeStr(pick(row, ["Spieletitel","Spiel","Titel","Title"]));
    const genre = safeStr(pick(row, ["Genre","Hauptgenre"]));
    const dev = safeStr(pick(row, ["Entwickler","Developer"]));
    const subgenre = safeStr(pick(row, ["Subgenre","Subgenre / Stimmung","Subgenre/Stimmung"]));
    const main = safeStr(pick(row, ["Spielzeit (Main)","Spielzeit Main","Main","Main Story (Std.)"]));
    const hundred = safeStr(pick(row, ["Spielzeit (100%)","100% (Std.)","Hundert","Completionist"]));
    const meta = safeStr(pick(row, ["Metascore","Pressemeinung (√ò)"]));
    const user = safeStr(pick(row, ["Userwertung","Userwertung (√ò)"]));
    const desc = safeStr(pick(row, ["Kurzbeschreibung","Beschreibung","Description"]));
    const storeLink = safeStr(pick(row, ["Store Link","Store","Link"]));
    const systems = parseSystems(row);
    const quelle = parseQuelle(row);
    const avail = parseAvail(row);
    const fav = parseFav(row);
    const trop = trophyInfo(row);

    const hsTotal = safeStr(pick(row, ["Gesamtstunden (Humorstatistik)","Gesamtstunden","Humorstatistik ‚Äì Gesamtstunden"]));
    const hsPct = safeStr(pick(row, ["% Lebenszeit (Humorstatistik)","% Lebenszeit","Humorstatistik ‚Äì % Lebenszeit"]));
    const hsYears = safeStr(pick(row, ["Jahre (Humorstatistik)","Jahre","Humorstatistik ‚Äì Jahre"]));

    // Status-Pill: Verf√ºgbarkeit
    let availClass = "ok";
    if (/delisted/i.test(avail)) availClass = "danger";
    if (!avail) availClass = "warn";

    return {
      raw: row,
      id: Number.isFinite(id) ? id : null,
      title,
      genre,
      dev,
      subgenre,
      main,
      hundred,
      meta,
      user,
      desc,
      storeLink,
      systems,
      quelle,
      avail,
      availClass,
      fav,
      trop,
      hsTotal, hsPct, hsYears
    };
  }

  function rebuildSheetSelect() {
    elSheet.innerHTML = "";
    if (!state.wb) return;
    for (const name of state.wb.SheetNames) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      elSheet.appendChild(opt);
    }
    elSheet.disabled = false;
  }

  function readSheet(name) {
    const ws = state.wb.Sheets[name];
    const arr = window.XLSX.utils.sheet_to_json(ws, { defval: "" });
    state.rows = arr.map(normalizeRow).filter(r => r.title || r.id !== null);
    state.renderCount = 40;
    applyAll();
  }

  function openSheet(){
  // make sure overlay participates in layout before we animate opacity
  overlay.style.display = "block";
  document.body.classList.add("noScroll");
  requestAnimationFrame(()=>{
    overlay.classList.add("open");
    sheet.classList.add("open");
  });
}
  function closeSheet(){
  overlay.classList.remove("open");
  sheet.classList.remove("open");
  document.body.classList.remove("noScroll");
  // after transition, fully hide overlay to avoid "stuck" remnants on some mobile browsers
  window.setTimeout(()=>{
    if(!overlay.classList.contains("open")){
      overlay.style.display = "none";
    }
  }, 240);
}

  function applyFilters(rows) {
    const q = state.search.toLowerCase().trim();
    let out = rows;

    if (q) {
      out = out.filter(r => {
        const hay = `${r.id ?? ""} ${r.title} ${r.genre} ${r.dev} ${r.subgenre}`.toLowerCase();
        return hay.includes(q);
      });
    }

    if (state.fSystem) {
      out = out.filter(r => r.systems.some(s => s.toLowerCase() === state.fSystem.toLowerCase()));
    }
    if (state.fQuelle) {
      out = out.filter(r => r.quelle.toLowerCase() === state.fQuelle.toLowerCase());
    }
    if (state.fAvail) {
      out = out.filter(r => r.avail.toLowerCase() === state.fAvail.toLowerCase());
    }
    if (state.fFav === "only") out = out.filter(r => r.fav);
    if (state.fFav === "no") out = out.filter(r => !r.fav);

    if (state.fTrophy) {
      out = out.filter(r => {
        const t = r.trop;
        switch (state.fTrophy) {
          case "platinum": return t.hasPlat;
          case "no-platinum": return !t.hasPlat;
          case "in-progress": return t.inProgress;
          case "completed": return t.has100;
          case "unplayed": return t.unplayed;
          default: return true;
        }
      });
    }

    return out;
  }

  function sortRows(rows) {
    const dir = state.sortDir === "desc" ? -1 : 1;
    const key = state.sortBy;

    const get = (r) => {
      switch (key) {
        case "id": return r.id ?? 999999999;
        case "title": return r.title.toLowerCase();
        case "genre": return r.genre.toLowerCase();
        case "meta": return parseNum(r.meta);
        case "user": return parseNum(r.user);
        case "main": {
          // versucht "10h" -> 10
          const m = String(r.main).match(/(\d+(?:[\.,]\d+)?)/);
          return m ? parseFloat(m[1].replace(",", ".")) : NaN;
        }
        case "fav": return r.fav ? 0 : 1; // Favoriten nach oben
        default: return r.id ?? 999999999;
      }
    };

    return [...rows].sort((a,b) => {
      const av = get(a), bv = get(b);
      const aNan = Number.isNaN(av), bNan = Number.isNaN(bv);
      if (aNan && bNan) return 0;
      if (aNan) return 1;
      if (bNan) return -1;
      if (typeof av === "number" && typeof bv === "number") return (av - bv) * dir;
      return (String(av).localeCompare(String(bv), "de")) * dir;
    });
  }

  function updateSummary(rowsAll) {
    if (!rowsAll.length) {
      elSummary.style.display = "none";
      elSummary.innerHTML = "";
      return;
    }
    const plat = rowsAll.filter(r => r.trop.hasPlat).length;
    const c100 = rowsAll.filter(r => r.trop.has100).length;
    const inprog = rowsAll.filter(r => r.trop.inProgress).length;
    const fav = rowsAll.filter(r => r.fav).length;
    const unplayed = rowsAll.filter(r => r.trop.unplayed).length;

    elSummary.innerHTML = "";
    const mk = (label, val) => {
      const s = document.createElement("span");
      s.className = "chip";
      s.innerHTML = `${label}: <strong>${val}</strong>`;
      elSummary.appendChild(s);
    };
    mk("üíé Platin", plat);
    mk("‚úÖ 100%", c100);
    mk("‚è≥ In Arbeit", inprog);
    mk("üí§ Ungespielt", unplayed);
    mk("‚≠ê Favorit", fav);
    mk(`${rowsAll.length} / ${rowsAll.length}`, rowsAll.length);

    elSummary.style.display = "flex";
  }

  function cardHtml(r) {
    // Kopfzeilen-Layout (Build 6.6c+):
    // Zeile 1: ID-Badge + Titel + (optional) Favorit
    // Zeile 2: Plattform-Badges + Quelle + Verf√ºgbarkeit
    // Zeile 3: Genre
    // Zeile 4: Trophy-Status

    const idPill = `<span class="pill id">ID ${r.id ?? "?"}</span>`;
    const favPill = r.fav ? `<span class="pill fav">‚≠ê Favorit</span>` : "";

    const rowPlatforms = [];
    for (const s of r.systems.slice(0, 4)) rowPlatforms.push(`<span class="pill">${escapeHtml(s)}</span>`);
    if (r.quelle) rowPlatforms.push(`<span class="pill source">${escapeHtml(r.quelle)}</span>`);
    if (r.avail) rowPlatforms.push(`<span class="pill ${r.availClass}">${escapeHtml(r.avail)}</span>`);

    const rowGenre = r.genre ? `<span class="pill genre">${escapeHtml(r.genre)}</span>` : "";

    const rowTrophies = [];
    const t = r.trop;
    if (t.hasPlat) rowTrophies.push(`<span class="pill">üíé Platin</span>`);
    else rowTrophies.push(`<span class="pill">‚óá Kein Platin</span>`);
    if (t.has100) rowTrophies.push(`<span class="pill">‚úÖ 100%</span>`);
    else if (t.inProgress) rowTrophies.push(`<span class="pill">‚è≥ In Arbeit</span>`);
    else if (t.unplayed) rowTrophies.push(`<span class="pill">üí§ Ungespielt</span>`);

    const kv = [];
    if (r.subgenre) kv.push(rowKV("Subgenre", r.subgenre));
    if (r.dev) kv.push(rowKV("Entwickler", r.dev));
    if (r.main || r.hundred) kv.push(rowKV("Spielzeit", `${r.main || "?"} / ${r.hundred || "?"}`));
    if (r.meta) kv.push(rowKV("Metascore", r.meta));
    if (r.user) kv.push(rowKV("Userwertung", r.user));

    const descBlock = r.desc
      ? `<details class="subdetails"><summary>Beschreibung <span class="chev">‚åÑ</span></summary><div class="text">${escapeHtml(r.desc)}</div></details>`
      : "";

    const storeRows = [];
    if (r.quelle) storeRows.push(trRow("Quelle", r.quelle));
    if (r.storeLink) storeRows.push(trRow("Store", `<a href="${escapeAttr(r.storeLink)}" target="_blank" rel="noopener">Store Link</a>`));
    if (r.avail) storeRows.push(trRow("Verf√ºgbarkeit", r.avail));
    const storeBlock = storeRows.length
      ? `<details class="subdetails"><summary>Store <span class="chev">‚åÑ</span></summary><table class="table">${storeRows.join("")}</table></details>`
      : "";

    const trophyRows = [];
    const rawProg = safeStr(r.raw["Troph√§en Fortschritt"]);
    const raw100 = safeStr(r.raw["100%"]);
    const rawPlat = safeStr(r.raw["Platin"]);
    if (rawProg) trophyRows.push(trRow("Fortschritt", escapeHtml(rawProg).replaceAll("\n","<br>")));
    if (raw100) trophyRows.push(trRow("100%", escapeHtml(raw100).replaceAll("\n","<br>")));
    if (rawPlat) trophyRows.push(trRow("Platin", escapeHtml(rawPlat).replaceAll("\n","<br>")));
    const trophyBlock = trophyRows.length
      ? `<details class="subdetails"><summary>Troph√§en <span class="chev">‚åÑ</span></summary><table class="table">${trophyRows.join("")}</table></details>`
      : "";

    const hsRows = [];
    if (r.hsTotal) hsRows.push(trRow("Gesamtstunden", escapeHtml(r.hsTotal)));
    if (r.hsPct) hsRows.push(trRow("% Lebenszeit", escapeHtml(r.hsPct)));
    if (r.hsYears) hsRows.push(trRow("Jahre", escapeHtml(r.hsYears)));
    const hsBlock = hsRows.length
      ? `<details class="subdetails"><summary>Humorstatistik <span class="chev">‚åÑ</span></summary><table class="table">${hsRows.join("")}</table></details>`
      : "";

    return `
      <article class="card">
        <div class="cardHeader">
          <div class="titleLine">
            ${idPill}
            <div class="cardTitleText">${escapeHtml(r.title || "‚Äî")}</div>
            ${favPill}
          </div>
          <div class="row">${rowPlatforms.join("")}</div>
          ${rowGenre ? `<div class="row">${rowGenre}</div>` : ""}
          <div class="row">${rowTrophies.join("")}</div>
        </div>

        <div class="kv">${kv.join("")}</div>

        <details>
          <summary>Mehr Details <span class="chev">‚åÑ</span></summary>
          ${descBlock}
          ${storeBlock}
          ${trophyBlock}
          ${hsBlock}
        </details>
      </article>
    `;
  }

  function rowKV(k, v) {
    return `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div>`;
  }
  function trRow(k, vHtml) {
    return `<tr><td>${escapeHtml(k)}</td><td>${vHtml}</td></tr>`;
  }
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
  }
  function escapeAttr(s) {
    return String(s ?? "").replace(/"/g,"&quot;");
  }

  function render() {
    const rows = state.filtered;
    const total = rows.length;
    const n = Math.min(state.renderCount, total);

    elHit.textContent = total;
    elShown.textContent = n;
    elTotal.textContent = total;

    // Render only first n
    const frag = document.createDocumentFragment();
    elList.innerHTML = "";
    for (let i=0; i<n; i++) {
      const tmp = document.createElement("div");
      tmp.innerHTML = cardHtml(rows[i]);
      frag.appendChild(tmp.firstElementChild);
    }
    elList.appendChild(frag);
  }

  function applyAll() {
    const filtered = applyFilters(state.rows);
    const sorted = sortRows(filtered);
    state.filtered = sorted;
    updateSummary(state.filtered);
    render();
  }

  function bumpRenderCount() {
    state.renderCount += 40;
    render();
  }

  function onScroll() {
    const y = window.scrollY || document.documentElement.scrollTop;
    const h = document.documentElement.scrollHeight - window.innerHeight;
    $("btnTop").classList.toggle("show", y > 900);

    if (h > 0 && (h - y) < 650) {
      if (state.renderCount < state.filtered.length) bumpRenderCount();
    }
  }

  function setFromUi() {
    state.sortBy = $("sortBy").value;
    state.sortDir = $("sortDir").value;
    state.fSystem = $("fSystem").value;
    state.fQuelle = $("fQuelle").value;
    state.fAvail = $("fAvail").value;
    state.fFav = $("fFav").value;
    state.fTrophy = $("fTrophy").value;
  }

  function clearFilters() {
    $("fSystem").value = "";
    $("fQuelle").value = "";
    $("fAvail").value = "";
    $("fFav").value = "";
    $("fTrophy").value = "";
    $("sortBy").value = "id";
    $("sortDir").value = "asc";
    setFromUi();
    applyAll();
  }

  // Events
  $("btnMenu").addEventListener("click", () => openSheet());
  $("sheetClose").addEventListener("click", closeSheet);
  overlay.addEventListener("click", closeSheet);
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeSheet();
  });

  $("btnApply").addEventListener("click", () => {
    setFromUi();
    state.renderCount = 40;
    applyAll();
    closeSheet();
  });
  $("btnClearFilters").addEventListener("click", () => {
    clearFilters();
    closeSheet();
  });

  $("btnLoad").addEventListener("click", () => elFile.click());
  elFile.addEventListener("change", async () => {
    const f = elFile.files && elFile.files[0];
    if (!f) return;
    elFileState.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
    try {
      const buf = await f.arrayBuffer();
      state.wb = window.XLSX.read(buf, { type: "array" });
      rebuildSheetSelect();
      elSheet.value = state.wb.SheetNames[0];
      readSheet(elSheet.value);
    } catch (err) {
      console.error(err);
      alert("Fehler beim Lesen der XLSX. Details siehe Konsole.");
    }
  });

  elSheet.addEventListener("change", () => {
    if (!state.wb) return;
    readSheet(elSheet.value);
  });

  elQ.addEventListener("input", () => {
    state.search = elQ.value;
    state.renderCount = 40;
    applyAll();
  });

  $("btnReset").addEventListener("click", () => {
    elQ.value = "";
    state.search = "";
    state.renderCount = 40;
    clearFilters();
    // Workbook behalten; Reset meint nur UI/Filter
  });

  window.addEventListener("scroll", onScroll, { passive: true });

  // Startup
  setXlsxState();
  elQ.disabled = false;
  $("btnLoad").disabled = !window.XLSX;
  elSheet.disabled = true;
  elUptime.textContent = fmtTime(Date.now() - t0);
  setInterval(() => {
    elUptime.textContent = fmtTime(Date.now() - t0);
  }, 1000);

})();
</script>
</body>
</html>
