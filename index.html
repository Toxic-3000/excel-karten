<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Spieleliste</title>

  <!-- SheetJS: Lege xlsx.full.min.js in den gleichen Ordner -->
  <script src="./xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 10px 30px rgba(17,24,39,.06);
      --radius:18px;

      --badge-bg:#eef2ff;
      --badge-text:#3730a3;

      --ok-bg:#e8f7ee;
      --ok-text:#166534;

      --warn-bg:#ffe8e8;
      --warn-text:#991b1b;

      --plat-bg:#e8f0ff;
      --plat-text:#1d4ed8;

      --chip-bg:#f3f4f6;
      --chip-text:#111827;

      --del-bg:#fff1f2;
      --del-text:#9f1239;

      --focus:#c7d2fe;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:16px 14px 90px;
    }

    /* Header / Mini menu */
    .topbar{
      position:sticky;
      top:0;
      z-index:20;
      background:linear-gradient(to bottom, rgba(246,247,251,.96), rgba(246,247,251,.86));
      backdrop-filter: blur(8px);
      padding:10px 0 12px;
      transition: transform .18s ease, opacity .18s ease;
      will-change: transform;
    }

    .title{
      font-size:26px;
      font-weight:800;
      letter-spacing:.2px;
      margin:4px 0 12px;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .fileRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    @media (max-width:720px){
      .fileRow{grid-template-columns:1fr}
    }

    label.small{
      font-size:12px;
      color:var(--muted);
      display:block;
      margin-bottom:6px;
    }

    input[type="file"]{width:100%}
    select, input[type="text"], button{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      background:#fff;
      color:var(--text);
      outline:none;
    }

    input[type="text"]:focus, select:focus, button:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(199,210,254,.45);
    }

    button{
      cursor:pointer;
      font-weight:700;
    }
    button.secondary{
      background:#fff;
    }
    button.icon{
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }

    .miniHeader{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .miniHeader .search{
      flex:1;
    }
    .hamburger{
      width:52px;
      height:48px;
      border-radius:14px;
      background:var(--badge-bg);
      color:var(--badge-text);
      border:1px solid var(--line);
      font-weight:900;
    }

    .menu{
      margin-top:10px;
      display:none;
    }
    .menu.open{display:block}

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip-bg);
      color:var(--chip-text);
      font-weight:700;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip.on{
      border-color:transparent;
      background:var(--badge-bg);
      color:var(--badge-text);
    }
    .chip.ok.on{ background:var(--ok-bg); color:var(--ok-text); }
    .chip.warn.on{ background:var(--warn-bg); color:var(--warn-text); }
    .chip.plat.on{ background:var(--plat-bg); color:var(--plat-text); }
    .chip.del.on{ background:var(--del-bg); color:var(--del-text); }

    .meta{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      color:var(--muted);
      font-size:14px;
    }

    .hint{
      margin-top:10px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      color:var(--muted);
      font-size:14px;
    }
    .hint summary{
      cursor:pointer;
      font-weight:800;
      color:var(--text);
      outline:none;
    }
    .hint p{margin:8px 0 0; line-height:1.45}

    /* Cards */
    .cards{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .card.delisted{
      border-color:#fecdd3;
      background:linear-gradient(to bottom, #fff, #fff, #fff, #fff, #fff1f2);
    }

    .cardHead{
      padding:14px 14px 8px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }

    .hLeft{
      min-width:0;
      flex:1;
    }

    .titleLine{
      font-size:20px;
      font-weight:900;
      line-height:1.2;
      margin:0 0 10px;
      word-break:break-word;
    }

    .titleLine.del{
      color:var(--del-text);
      text-decoration:line-through;
      text-decoration-thickness:2px;
    }

    .badgesCol{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
      flex:0 0 auto;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.08);
      background:var(--badge-bg);
      color:var(--badge-text);
      font-weight:800;
      font-size:14px;
      white-space:nowrap;
    }
    .badge.ok{ background:var(--ok-bg); color:var(--ok-text); }
    .badge.warn{ background:var(--warn-bg); color:var(--warn-text); }
    .badge.plat{ background:var(--plat-bg); color:var(--plat-text); }
    .badge.del{ background:var(--del-bg); color:var(--del-text); }

    .subBadges{
      padding:0 14px 10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      padding:8px 10px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid var(--line);
      font-weight:800;
      color:#111827;
      font-size:14px;
    }
    .pill.id{
      background:#1f2a74;
      color:#fff;
      border-color:transparent;
    }
    .pill.avail{
      background:#eef2ff;
      color:#3730a3;
      border-color:transparent;
    }
    .pill.avail.del{
      background:var(--del-bg);
      color:var(--del-text);
    }

    .divider{height:1px;background:var(--line);margin:0 14px}

    .kv{
      padding:10px 14px;
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:10px 14px;
      align-items:start;
      font-size:15px;
    }
    @media (max-width:720px){
      .kv{grid-template-columns: 140px 1fr;}
    }
    .k{color:var(--muted); font-weight:700;}
    .v{color:var(--text); font-weight:800; word-break:break-word;}
    .v.muted{color:var(--muted); font-weight:700;}

    .detailsToggle{
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:10px;
      color:#1f2a74;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .detailsToggle .chev{
      transition: transform .15s ease;
    }
    .detailsToggle.open .chev{transform:rotate(90deg)}
    .details{
      display:none;
      padding:6px 0 14px;
    }
    .details.open{display:block}

    .section{
      padding:8px 14px 4px;
    }
    .sectionTitle{
      font-size:12px;
      letter-spacing:.12em;
      font-weight:900;
      color:var(--muted);
      margin:10px 0 8px;
    }

    .expander{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:10px 12px;
      margin-top:8px;
    }
    .expander summary{
      cursor:pointer;
      font-weight:900;
      color:#1f2a74;
      outline:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .expander .content{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      color:#111827;
      font-weight:700;
      line-height:1.5;
      white-space:pre-wrap;
      word-break:break-word;
    }

    .storeLink{
      color:#1d4ed8;
      text-decoration:none;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .storeLink:visited{color:#1d4ed8}
    .storeLink small{color:var(--muted); font-weight:700}

    /* Trophies */
    .trophyBlock{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:8px;
    }
    .tRow{
      border:1px solid var(--line);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
    }
    .tTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tPlat{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .miniPill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f3f4f6;
      font-weight:900;
      font-size:13px;
    }
    .miniPill.ok{background:var(--ok-bg); color:var(--ok-text); border-color:transparent;}
    .miniPill.warn{background:var(--warn-bg); color:var(--warn-text); border-color:transparent;}
    .miniPill.plat{background:var(--plat-bg); color:var(--plat-text); border-color:transparent;}

    .bar{
      height:10px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
      position:relative;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background:#1f2a74;
      border-radius:999px;
    }
    .barNote{
      margin-top:6px;
      color:var(--muted);
      font-weight:800;
      font-size:13px;
    }

    /* Table view */
    .tableWrap{
      margin-top:14px;
      display:none;
    }
    .tableWrap.open{display:block}
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      font-size:14px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.02em;
      background:#fafafa;
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:last-child td{border-bottom:none}
    td b{font-weight:900}

    /* Floating buttons */
    .floatBtns{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:30;
    }
    .fab{
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      box-shadow: var(--shadow);
      background:#fff;
      border:1px solid var(--line);
      cursor:pointer;
      width:auto;
    }
    .fab.primary{
      background:#1f2a74;
      color:#fff;
      border-color:transparent;
    }

    .mutedSmall{color:var(--muted); font-size:12px; font-weight:800}
    .statusLine{margin-top:8px;color:var(--muted);font-size:14px;font-weight:800}
    .hidden{display:none !important}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar" id="topbar">
      <div class="title">Spieleliste</div>

      <div class="panel">
        <!-- Mini header: search + hamburger -->
        <div class="miniHeader">
          <input class="search" id="q" type="text" placeholder="Suche‚Ä¶ (z.B. id:643, capcom, delisted)" autocomplete="off" />
          <button class="hamburger" id="btnMenu" title="Men√º">‚ò∞</button>
        </div>

        <div class="menu" id="menu">
          <div class="fileRow" style="margin-top:10px;">
            <div>
              <label class="small">Datei (XLSX oder CSV)</label>
              <input id="file" type="file" accept=".xlsx,.xls,.csv" />
              <div class="mutedSmall" style="margin-top:6px;">Alles l√§uft lokal im Browser (keine Uploads).</div>
            </div>
            <div>
              <label class="small">Sheet ausw√§hlen</label>
              <select id="sheet" disabled>
                <option value="">‚Äî</option>
              </select>
            </div>
          </div>

          <div class="grid" style="margin-top:10px;">
            <div>
              <label class="small">Ansicht</label>
              <select id="viewMode">
                <option value="cards">Kartenansicht</option>
                <option value="table">Tabellenansicht</option>
              </select>
            </div>
            <div>
              <label class="small">Sortierung</label>
              <select id="sortKey">
                <option value="id">ID</option>
                <option value="title">Spieletitel (Text, stabil)</option>
                <option value="system">System</option>
                <option value="quelle">Quelle</option>
                <option value="genre">Genre</option>
                <option value="dev">Entwickler</option>
                <option value="main">Spielzeit (Main)</option>
                <option value="meta">Metascore</option>
                <option value="user">Userwertung</option>
                <option value="life">Lebenszeit %</option>
              </select>
              <div class="row" style="margin-top:10px;">
                <button class="secondary icon" id="sortAsc" title="Aufsteigend">A‚ÜíZ</button>
                <button class="secondary icon" id="sortDesc" title="Absteigend">Z‚ÜíA</button>
              </div>
            </div>
          </div>

          <details class="hint">
            <summary>Suche & Filter kurz erkl√§rt</summary>
            <p>
              Suche findet in allen Spalten. Extra: <b>id:123</b> f√ºr genaue ID, <b>delisted</b>, <b>ps4</b>, <b>ps plus</b> etc.
              Filter bauen auf deinen eindeutigen Werten (Quelle) und den abgeleiteten Troph√§en-Zust√§nden auf.
            </p>
          </details>

          <div class="chips" id="chips">
            <!-- Platforms -->
            <div class="chip" data-filter="p:PS5">PS5</div>
            <div class="chip" data-filter="p:PS4">PS4</div>
            <div class="chip" data-filter="p:PS3">PS3</div>
            <div class="chip" data-filter="p:Vita">Vita</div>

            <!-- Source -->
            <div class="chip" data-filter="src:Digital">Digital</div>
            <div class="chip" data-filter="src:PS Plus">PS Plus</div>
            <div class="chip" data-filter="src:Retail-Disc">Retail-Disc</div>

            <!-- Flags -->
            <div class="chip" data-filter="fav" title="Nur Favoriten">‚≠ê Favorit</div>
            <div class="chip plat" data-filter="plat" title="Platin erlangt (mind. eine Plattform)">üíé Platin</div>
            <div class="chip ok" data-filter="comp" title="100% erreicht (mind. eine Plattform)">‚úÖ 100%</div>
            <div class="chip warn" data-filter="work" title="In Arbeit (gestartet, aber noch nicht 100%)">‚è≥ In Arbeit</div>
            <div class="chip" data-filter="unplayed" title="Noch nicht gestartet (alle Troph√§en-Felder leer)">üí§ Ungespielt</div>
            <div class="chip del" data-filter="del" title="Delisted">üü• Delisted</div>

            <div class="chip" id="clearFilters">Filter l√∂schen</div>
          </div>
        </div>

        <div class="meta">
          <div id="statusText">Datei w√§hlen ‚Üí Sheet w√§hlen ‚Üí suchen</div>
          <div style="flex:1"></div>
          <div id="countText"></div>
        </div>
      </div>
    </div>

    <div class="tableWrap" id="tableWrap"></div>
    <div class="cards" id="cards"></div>

    <!-- sentinel for infinite scroll -->
    <div id="sentinel" style="height:1px;"></div>
  </div>

  <div class="floatBtns">
    <button class="fab" id="btnTop" title="Nach oben">‚Üë Top</button>
  </div>

<script>
(() => {
  // -------------------------
  // Utilities
  // -------------------------
  const $ = (id) => document.getElementById(id);

  const LS_KEY = "spieleliste_v1";
  const PLATFORMS = ["PS3","PS4","PS5","Vita"];

  const state = {
    wb: null,
    fileName: "",
    sheetName: "",
    rows: [],
    rowsView: [],
    rendered: 0,
    batch: 40,
    sortKey: "id",
    sortDir: "asc",
    viewMode: "cards",
    q: "",
    filters: new Set(),
    menuOpen: false
  };

  function saveState(){
    const obj = {
      sheetName: state.sheetName,
      sortKey: state.sortKey,
      sortDir: state.sortDir,
      viewMode: state.viewMode,
      q: state.q,
      filters: Array.from(state.filters),
      menuOpen: state.menuOpen
    };
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      state.sheetName = obj.sheetName || "";
      state.sortKey = obj.sortKey || "id";
      state.sortDir = obj.sortDir || "asc";
      state.viewMode = obj.viewMode || "cards";
      state.q = obj.q || "";
      state.filters = new Set(obj.filters || []);
      state.menuOpen = !!obj.menuOpen;
    }catch(e){}
  }

  function normStr(x){
    return String(x ?? "").replace(/\u00A0/g," ").replace(/\s+/g," ").trim();
  }

  function normQuelle(raw){
    const s = normStr(raw);
    if(!s) return "";
    if(/^gekauft$/i.test(s)) return "Digital"; // legacy
    if(/^disc$/i.test(s)) return "Retail-Disc"; // legacy
    if(/^digital$/i.test(s)) return "Digital";
    if(/^ps\s*plus$/i.test(s)) return "PS Plus";
    if(/^retail[-\s]*disc$/i.test(s)) return "Retail-Disc";
    return s;
  }

  function parseNum(x){
    const s = normStr(x).replace(",", ".");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function parseScore(x){
    // "79 / 100" -> 79
    const s = normStr(x);
    const m = s.match(/(\d+(?:[.,]\d+)?)/);
    if(!m) return NaN;
    return parseNum(m[1]);
  }

  function parsePlatformsFromSystem(systemRaw){
    const s = normStr(systemRaw);
    return PLATFORMS.filter(p => new RegExp(`\\b${p}\\b`,"i").test(s));
  }

  function splitByPlatformBlocks(textRaw){
    const text = String(textRaw ?? "").replace(/\r/g,"\n").trim();
    if(!text) return [];
    const re = /\b(PS3|PS4|PS5|Vita)\b/gi;
    const matches = [];
    let m;
    while((m = re.exec(text)) !== null){
      matches.push({ p: m[1], i: m.index });
    }
    if(!matches.length) return [];
    const blocks = [];
    for(let k=0;k<matches.length;k++){
      const start = matches[k].i;
      const end = (k+1<matches.length) ? matches[k+1].i : text.length;
      blocks.push(text.slice(start,end).trim());
    }
    return blocks;
  }

  function parseProgressCell(raw){
    // "PS4 06 of 21" possibly with linebreaks and multiple platforms
    const out = {}; // {PS4:{cur,total}}
    for(const block of splitByPlatformBlocks(raw)){
      const plat = (block.match(/\b(PS3|PS4|PS5|Vita)\b/i) || [])[1];
      const nums = block.match(/(\d+)\s*of\s*(\d+)/i);
      if(!plat) continue;
      if(nums){
        out[plat] = { cur: parseInt(nums[1],10), total: parseInt(nums[2],10) };
      }
    }
    return out;
  }

  function parseCompletionCell(raw){
    // "PS4 In Progress" / "PS4 Completed"
    const out = {}; // {PS4:"In Progress"|"Completed"}
    for(const block of splitByPlatformBlocks(raw)){
      const plat = (block.match(/\b(PS3|PS4|PS5|Vita)\b/i) || [])[1];
      if(!plat) continue;
      if(/completed/i.test(block)) out[plat] = "Completed";
      else if(/in\s*progress/i.test(block)) out[plat] = "In Progress";
    }
    return out;
  }

  function parsePlatinumCell(raw){
    // "PS4 Platinum" / "PS4 No Platinum" / "PS4 In Progress"
    const out = {}; // {PS4:"Platinum"|"No Platinum"|"In Progress"}
    for(const block of splitByPlatformBlocks(raw)){
      const plat = (block.match(/\b(PS3|PS4|PS5|Vita)\b/i) || [])[1];
      if(!plat) continue;
      if(/no\s*platinum/i.test(block)) out[plat] = "No Platinum";
      else if(/\bplatinum\b/i.test(block)) out[plat] = "Platinum";
      else if(/in\s*progress/i.test(block)) out[plat] = "In Progress";
    }
    return out;
  }

  function isTruthyFavorite(x){
    const s = normStr(x).toLowerCase();
    return s === "x" || s === "1" || s === "true" || s === "yes" || s === "y";
  }

  function isDelisted(row){
    const v = normStr(row["Verf√ºgbarkeit"]).toLowerCase();
    return v.includes("delisted") || v.includes("dellist") || v.includes("aus store entfernt");
  }

  function buildTrophyModel(row){
    const platforms = parsePlatformsFromSystem(row["System"]);
    const pMap = parseProgressCell(row["Troph√§en Fortschritt"]);
    const cMap = parseCompletionCell(row["100%"]);
    const plMap = parsePlatinumCell(row["Platin"]);

    const anyStarted = Object.keys(pMap).length || Object.keys(cMap).length || Object.keys(plMap).length;

    const perPlatform = {};
    for(const p of platforms){
      if(!anyStarted){
        perPlatform[p] = { started:false, state:"Ungespielt", progress:null, completion:null, platinum:null };
        continue;
      }
      const hasAny = (p in pMap) || (p in cMap) || (p in plMap);
      if(!hasAny){
        perPlatform[p] = { started:false, state:"Ungespielt", progress:null, completion:null, platinum:null };
      }else{
        perPlatform[p] = { started:true, state:"Gespielt", progress:pMap[p]||null, completion:cMap[p]||null, platinum:plMap[p]||null };
      }
    }

    const hasCompleted = Object.values(cMap).some(v => v === "Completed");
    const hasCompletionWork = Object.values(cMap).some(v => v === "In Progress");
    const hasPlatinum = Object.values(plMap).some(v => v === "Platinum");
    const hasPlatinumWork = Object.values(plMap).some(v => v === "In Progress");
    const hasAnyWork = !!anyStarted && (!hasCompleted || hasCompletionWork || hasPlatinumWork) && !hasPlatinum; // simple signal

    return {
      platforms,
      anyStarted: !!anyStarted,
      perPlatform,
      hasCompleted,
      hasCompletionWork,
      hasPlatinum,
      hasPlatinumWork,
      hasAnyWork
    };
  }

  function cellToLink(wb, sheetName, rowObj){
    // Prefer a hyperlink if present in "Store Link" cell.
    // Because we read rows via sheet_to_json, we might lose the link.
    // Workaround: if Store Link looks like URL -> use it.
    const raw = normStr(rowObj["Store Link"]);
    if(!raw) return { href:"", label:"‚Äî", title:"" };
    const looksUrl = /^https?:\/\//i.test(raw);
    if(looksUrl) return { href: raw, label: "Store Link", title: raw };

    // If the cell contains just "Store Link" (Excel label), try to locate a hyperlink in the sheet cell object.
    try{
      const ws = wb.Sheets[sheetName];
      if(!ws) throw 0;

      // Find row index by matching ID in column "ID"
      // We'll scan a small window by reading the sheet range and checking the ID column values.
      const range = XLSX.utils.decode_range(ws["!ref"]);
      // Find header row (assume first row)
      const headerRow = range.s.r;
      const colCount = range.e.c - range.s.c + 1;

      // Map headers to columns
      const headerMap = {};
      for(let c=range.s.c; c<=range.e.c; c++){
        const addr = XLSX.utils.encode_cell({r: headerRow, c});
        const cell = ws[addr];
        const txt = normStr(cell ? cell.v : "");
        if(txt) headerMap[txt] = c;
      }
      const idCol = headerMap["ID"];
      const linkCol = headerMap["Store Link"];
      if(idCol == null || linkCol == null) throw 0;

      const targetId = normStr(rowObj["ID"]);
      // scan down until match (reasonable for your sheet size)
      for(let r=headerRow+1; r<=range.e.r; r++){
        const idAddr = XLSX.utils.encode_cell({r, c:idCol});
        const idCell = ws[idAddr];
        const idVal = normStr(idCell ? idCell.v : "");
        if(idVal && idVal === targetId){
          const lAddr = XLSX.utils.encode_cell({r, c:linkCol});
          const lCell = ws[lAddr];
          // SheetJS stores hyperlinks at cell.l.Target sometimes
          const href = lCell && lCell.l && lCell.l.Target ? String(lCell.l.Target) : "";
          if(href) return { href, label:"Store Link", title: href };
          break;
        }
      }
    }catch(e){}

    // fallback: show non-clickable
    return { href:"", label: raw, title:"" };
  }

  // -------------------------
  // Data loading
  // -------------------------
  function setStatus(msg){
    $("statusText").textContent = msg;
  }

  function setCount(msg){
    $("countText").textContent = msg || "";
  }

  function fillSheetSelect(wb){
    const sel = $("sheet");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Sheet ausw√§hlen‚Ä¶";
    sel.appendChild(opt0);

    wb.SheetNames.forEach(name=>{
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      sel.appendChild(o);
    });

    sel.disabled = false;

    if(state.sheetName && wb.SheetNames.includes(state.sheetName)){
      sel.value = state.sheetName;
      loadSheet(state.sheetName);
    }
  }

  function readFileAsArrayBuffer(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onerror = () => reject(new Error("Datei konnte nicht gelesen werden."));
      fr.onload = () => resolve(fr.result);
      fr.readAsArrayBuffer(file);
    });
  }

  async function handleFile(file){
    if(!file) return;

    state.fileName = file.name;
    setStatus("Lese Datei‚Ä¶");
    setCount("");

    try{
      const buf = await readFileAsArrayBuffer(file);
      const wb = XLSX.read(buf, { type:"array", cellStyles:false, cellHTML:false });
      state.wb = wb;
      fillSheetSelect(wb);
      setStatus(`Datei geladen: ${file.name}`);
    }catch(e){
      console.error(e);
      setStatus("Fehler beim Einlesen. (Tipp: xlsx.full.min.js korrekt eingebunden?)");
    }
  }

  function sheetToRows(wb, sheetName){
    const ws = wb.Sheets[sheetName];
    if(!ws) return [];
    // defval ensures empty fields are preserved
    return XLSX.utils.sheet_to_json(ws, { defval:"", raw:false });
  }

  function loadSheet(sheetName){
    if(!state.wb || !sheetName) return;
    state.sheetName = sheetName;

    setStatus("Lade Sheet‚Ä¶");
    const rows = sheetToRows(state.wb, sheetName);

    // Normalize and enrich rows once (fast later)
    state.rows = rows.map(r=>{
      const row = Object.assign({}, r);

      row["Quelle"] = normQuelle(row["Quelle"]);
      row.__id = normStr(row["ID"]);
      row.__title = normStr(row["Spieletitel"]);
      row.__system = normStr(row["System"]);
      row.__genre = normStr(row["Genre"]);
      row.__dev = normStr(row["Entwickler"]);
      row.__fav = isTruthyFavorite(row["Favorit"]);
      row.__del = isDelisted(row);
      row.__trophy = buildTrophyModel(row);
      row.__src = row["Quelle"];

      // numeric helpers for sorting
      row.__main = parseNum(row["Spielzeit (Main)"]);
      row.__meta = parseScore(row["Metascore"]);
      row.__user = parseScore(row["Userwertung"]);
      row.__life = parseNum(row["% Lebenszeit (Humorstatistik)"]);

      // cache store link if possible
      row.__store = null;

      // fast search blob
      row.__blob = Object.keys(row)
        .filter(k => !k.startsWith("__"))
        .map(k => normStr(row[k]))
        .join(" | ")
        .toLowerCase();

      return row;
    });

    applyAll();
    setStatus(`Sheet geladen: ${sheetName}`);
    saveState();
  }

  // -------------------------
  // Filtering / sorting / search
  // -------------------------
  function queryMatch(row, q){
    q = normStr(q).toLowerCase();
    if(!q) return true;

    // id:123
    const m = q.match(/\bid\s*:\s*(\d+)\b/);
    if(m){
      return normStr(row.__id) === m[1];
    }
    return row.__blob.includes(q);
  }

  function filtersMatch(row){
    const f = state.filters;
    if(!f.size) return true;

    // platform filters: if any p:... active, require that platform to be present
    const pFilters = Array.from(f).filter(x => x.startsWith("p:")).map(x => x.slice(2));
    if(pFilters.length){
      const platforms = parsePlatformsFromSystem(row["System"]);
      for(const p of pFilters){
        if(!platforms.includes(p)) return false;
      }
    }

    // source filters: if any src active, require match
    const sFilters = Array.from(f).filter(x => x.startsWith("src:")).map(x => x.slice(4));
    if(sFilters.length){
      if(!sFilters.includes(row.__src)) return false;
    }

    if(f.has("fav") && !row.__fav) return false;
    if(f.has("del") && !row.__del) return false;

    const t = row.__trophy;

    if(f.has("unplayed") && t.anyStarted) return false;
    if(f.has("work") && (!t.anyStarted || t.hasCompleted)) return false; // started but not 100%
    if(f.has("comp") && !t.hasCompleted) return false;
    if(f.has("plat") && !t.hasPlatinum) return false;

    return true;
  }

  function sortRows(rows){
    const dir = state.sortDir === "asc" ? 1 : -1;
    const key = state.sortKey;

    const collator = new Intl.Collator("de-DE", { sensitivity:"base", numeric:true });

    function cmp(a,b){
      if(key === "id"){
        const ai = parseInt(a.__id,10); const bi = parseInt(b.__id,10);
        if(Number.isFinite(ai) && Number.isFinite(bi)) return (ai-bi)*dir;
        return collator.compare(a.__id, b.__id)*dir;
      }
      if(key === "title"){
        // stable: fallback to ID
        const c = collator.compare(a.__title, b.__title);
        if(c !== 0) return c*dir;
        const ai = parseInt(a.__id,10); const bi = parseInt(b.__id,10);
        return (ai-bi)*dir;
      }
      const map = {
        system: "__system",
        quelle: "__src",
        genre: "__genre",
        dev: "__dev"
      };
      if(map[key]){
        const c = collator.compare(a[map[key]] || "", b[map[key]] || "");
        if(c !== 0) return c*dir;
        const ai = parseInt(a.__id,10); const bi = parseInt(b.__id,10);
        return (ai-bi)*dir;
      }
      const nmap = {
        main: "__main",
        meta: "__meta",
        user: "__user",
        life: "__life"
      };
      if(nmap[key]){
        const av = a[nmap[key]], bv = b[nmap[key]];
        const an = Number.isFinite(av) ? av : -Infinity;
        const bn = Number.isFinite(bv) ? bv : -Infinity;
        if(an !== bn) return (an-bn)*dir;
        const ai = parseInt(a.__id,10); const bi = parseInt(b.__id,10);
        return (ai-bi)*dir;
      }
      return 0;
    }

    // copy for stable-ish sorting
    const copy = rows.slice();
    copy.sort(cmp);
    return copy;
  }

  function applyAll(){
    const q = $("q").value;
    state.q = q;

    const filtered = state.rows.filter(r => queryMatch(r, q) && filtersMatch(r));
    const sorted = sortRows(filtered);

    state.rowsView = sorted;
    state.rendered = 0;

    // view toggles
    if(state.viewMode === "table"){
      $("cards").innerHTML = "";
      $("tableWrap").classList.add("open");
      renderTable(sorted);
    }else{
      $("tableWrap").classList.remove("open");
      $("tableWrap").innerHTML = "";
      $("cards").innerHTML = "";
      renderNextBatch(true);
    }

    setCount(`Treffer: ${filtered.length} ¬∑ angezeigt: ${Math.min(state.rendered, filtered.length)}/${filtered.length}`);
    saveState();
  }

  // -------------------------
  // Rendering
  // -------------------------
  function fmtVal(v){
    const s = normStr(v);
    return s ? s : "‚Äî";
  }

  function buildRowKV(label, value){
    const k = document.createElement("div");
    k.className = "k";
    k.textContent = label;

    const v = document.createElement("div");
    const txt = fmtVal(value);
    v.className = "v" + (txt === "‚Äî" ? " muted" : "");
    v.textContent = txt;

    return [k,v];
  }

  function makeExpander(title, text){
    const d = document.createElement("details");
    d.className = "expander";
    const s = document.createElement("summary");
    s.innerHTML = `<span>${title}</span><span class="mutedSmall">‚ñæ</span>`;
    const c = document.createElement("div");
    c.className = "content";
    c.textContent = fmtVal(text);
    d.appendChild(s);
    d.appendChild(c);
    return d;
  }

  function ensureStoreLink(row){
    if(row.__store) return row.__store;
    row.__store = cellToLink(state.wb, state.sheetName, row);
    return row.__store;
  }

  function badgeEl(text, cls){
    const b = document.createElement("div");
    b.className = "badge " + (cls || "");
    b.textContent = text;
    return b;
  }

  function cardEl(row){
    const del = row.__del;
    const t = row.__trophy;

    const card = document.createElement("div");
    card.className = "card" + (del ? " delisted" : "");

    // header
    const head = document.createElement("div");
    head.className = "cardHead";

    const left = document.createElement("div");
    left.className = "hLeft";

    const title = document.createElement("div");
    title.className = "titleLine" + (del ? " del" : "");
    title.textContent = fmtVal(row["Spieletitel"]);
    left.appendChild(title);

    head.appendChild(left);

    const right = document.createElement("div");
    right.className = "badgesCol";

    // Favorit / Platin / 100%
    if(row.__fav) right.appendChild(badgeEl("‚≠ê Favorit", ""));
    if(t.hasPlatinum) right.appendChild(badgeEl("üíé Platin erlangt", "plat"));
    else if(t.anyStarted && (t.hasPlatinumWork)) right.appendChild(badgeEl("‚è≥ Platin in Arbeit", "warn"));

    if(t.hasCompleted) right.appendChild(badgeEl("‚úÖ 100% erreicht", "ok"));
    else if(t.anyStarted) right.appendChild(badgeEl("‚è≥ In Arbeit", "warn"));

    head.appendChild(right);
    card.appendChild(head);

    // pills row
    const pills = document.createElement("div");
    pills.className = "subBadges";

    const idP = document.createElement("div");
    idP.className = "pill id";
    idP.textContent = "ID " + fmtVal(row["ID"]);
    pills.appendChild(idP);

    // platforms from System
    const plats = parsePlatformsFromSystem(row["System"]);
    for(const p of plats){
      const pEl = document.createElement("div");
      pEl.className = "pill";
      pEl.textContent = p;
      pills.appendChild(pEl);
    }

    const avail = normStr(row["Verf√ºgbarkeit"]);
    const av = document.createElement("div");
    av.className = "pill avail" + (del ? " del" : "");
    av.textContent = avail ? avail : "‚Äî";
    pills.appendChild(av);

    card.appendChild(pills);

    const div = document.createElement("div");
    div.className = "divider";
    card.appendChild(div);

    // reduced info (always visible)
    const kv = document.createElement("div");
    kv.className = "kv";

    // Reduced set: Genre, Entwickler, Spielzeit, Metascore, Userwertung (as you requested)
    const pairs = [
      ["Genre", row["Genre"]],
      ["Entwickler", row["Entwickler"]],
      ["Spielzeit", buildPlaytime(row)],
      ["Metascore", row["Metascore"]],
      ["Userwertung", row["Userwertung"]],
    ];
    for(const [k,v] of pairs){
      const [ke, ve] = buildRowKV(k, v);
      kv.appendChild(ke);
      kv.appendChild(ve);
    }
    card.appendChild(kv);

    // details toggle
    const tog = document.createElement("div");
    tog.className = "detailsToggle";
    tog.innerHTML = `<span class="chev">‚ñ∂</span><span class="txt">Mehr Details</span><span style="margin-left:auto" class="mutedSmall">Tippen</span>`;
    card.appendChild(tog);

    const details = document.createElement("div");
    details.className = "details";

    // Beschreibung
    const s1 = document.createElement("div");
    s1.className = "section";
    const st1 = document.createElement("div");
    st1.className = "sectionTitle";
    st1.textContent = "BESCHREIBUNG";
    s1.appendChild(st1);

    const expDesc = makeExpander("Kurzbeschreibung anzeigen", row["Kurzbeschreibung"]);
    s1.appendChild(expDesc);

    details.appendChild(s1);

    // STORE: Quelle, Store, Verf√ºgbarkeit (as you requested)
    const sStore = document.createElement("div");
    sStore.className = "section";
    const stS = document.createElement("div");
    stS.className = "sectionTitle";
    stS.textContent = "STORE";
    sStore.appendChild(stS);

    const kvS = document.createElement("div");
    kvS.className = "kv";
    // Quelle
    {
      const [ke, ve] = buildRowKV("Quelle", row["Quelle"]);
      kvS.appendChild(ke); kvS.appendChild(ve);
    }
    // Store Link (clickable)
    {
      const k = document.createElement("div");
      k.className = "k";
      k.textContent = "Store";

      const v = document.createElement("div");
      const link = ensureStoreLink(row);
      if(link.href){
        const a = document.createElement("a");
        a.className = "storeLink";
        a.href = link.href;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.title = link.title || link.href;
        a.innerHTML = `Store Link <small>‚Üó</small>`;
        v.appendChild(a);
      }else{
        v.className = "v muted";
        v.textContent = fmtVal(row["Store Link"]);
      }
      kvS.appendChild(k); kvS.appendChild(v);
    }
    // Verf√ºgbarkeit
    {
      const [ke, ve] = buildRowKV("Verf√ºgbarkeit", row["Verf√ºgbarkeit"]);
      kvS.appendChild(ke); kvS.appendChild(ve);
    }
    sStore.appendChild(kvS);
    details.appendChild(sStore);

    // ENTWICKLER (keep section for structure)
    const sDev = document.createElement("div");
    sDev.className = "section";
    const stD = document.createElement("div");
    stD.className = "sectionTitle";
    stD.textContent = "ENTWICKLER";
    sDev.appendChild(stD);
    const kvD = document.createElement("div");
    kvD.className = "kv";
    const [dk, dv] = buildRowKV("Entwickler", row["Entwickler"]);
    kvD.appendChild(dk); kvD.appendChild(dv);
    sDev.appendChild(kvD);
    details.appendChild(sDev);

    // EXTRAS: collapsible Besonderheiten / Eastereggs
    const sEx = document.createElement("div");
    sEx.className = "section";
    const stE = document.createElement("div");
    stE.className = "sectionTitle";
    stE.textContent = "EXTRAS";
    sEx.appendChild(stE);

    sEx.appendChild(makeExpander("Besonderheiten anzeigen", row["Besonderheiten"]));
    sEx.appendChild(makeExpander("Eastereggs anzeigen", row["Eastereggs"]));
    details.appendChild(sEx);

    // TROPH√ÑEN: Fortschritt + Komplettion + Platin, pro Plattform inkl Ungespielt
    const sT = document.createElement("div");
    sT.className = "section";
    const stT = document.createElement("div");
    stT.className = "sectionTitle";
    stT.textContent = "TROPH√ÑEN";
    sT.appendChild(stT);

    const tWrap = document.createElement("div");
    tWrap.className = "trophyBlock";

    const platforms = t.platforms;
    if(!platforms.length){
      const note = document.createElement("div");
      note.className = "mutedSmall";
      note.textContent = "Keine Plattform im System-Feld erkannt.";
      tWrap.appendChild(note);
    }else{
      for(const p of platforms){
        const info = t.perPlatform[p] || { state:"Ungespielt", started:false };

        const tr = document.createElement("div");
        tr.className = "tRow";

        const top = document.createElement("div");
        top.className = "tTop";

        const leftP = document.createElement("div");
        leftP.style.display = "flex";
        leftP.style.gap = "8px";
        leftP.style.alignItems = "center";

        const pill = document.createElement("div");
        pill.className = "miniPill";
        pill.textContent = p;
        leftP.appendChild(pill);

        const rightP = document.createElement("div");
        rightP.className = "tPlat";

        // Status badges in details:
        // If unplayed: show Ungespielt for Fortschritt, Komplettion, Platin as you requested earlier
        if(!info.started){
          rightP.appendChild(miniBadge("üí§ Ungespielt", ""));
        }else{
          // Completion
          if(info.completion === "Completed") rightP.appendChild(miniBadge("‚úÖ 100% erreicht", "ok"));
          else if(info.completion === "In Progress") rightP.appendChild(miniBadge("‚è≥ In Arbeit", "warn"));
          else rightP.appendChild(miniBadge("‚è≥ In Arbeit", "warn"));

          // Platinum
          if(info.platinum === "Platinum") rightP.appendChild(miniBadge("üíé Platin erlangt", "plat"));
          else if(info.platinum === "No Platinum") rightP.appendChild(miniBadge("‚Äî Kein Platin", ""));
          else if(info.platinum === "In Progress") rightP.appendChild(miniBadge("‚è≥ Platin in Arbeit", "warn"));
          else rightP.appendChild(miniBadge("‚è≥ Platin in Arbeit", "warn"));
        }

        top.appendChild(leftP);
        top.appendChild(rightP);
        tr.appendChild(top);

        // Progress display
        if(!info.started){
          const note = document.createElement("div");
          note.className = "mutedSmall";
          note.textContent = "Fortschritt: Ungespielt ¬∑ Komplettion: Ungespielt ¬∑ Platin: Ungespielt";
          tr.appendChild(note);
        }else{
          const pr = info.progress;
          if(pr && Number.isFinite(pr.cur) && Number.isFinite(pr.total) && pr.total > 0){
            const line = document.createElement("div");
            line.style.display = "flex";
            line.style.justifyContent = "space-between";
            line.style.gap = "10px";
            line.style.alignItems = "baseline";

            const b = document.createElement("div");
            b.style.fontWeight = "900";
            b.textContent = `${String(pr.cur).padStart(2,"0")} of ${pr.total}`;
            line.appendChild(b);

            const pct = Math.max(0, Math.min(100, (pr.cur/pr.total)*100));
            const bar = document.createElement("div");
            bar.className = "bar";
            const fill = document.createElement("i");
            fill.style.width = pct.toFixed(1) + "%";
            bar.appendChild(fill);

            const note = document.createElement("div");
            note.className = "barNote";
            note.textContent = `${pct.toFixed(0)}% (${pr.cur}/${pr.total})`;

            tr.appendChild(line);
            tr.appendChild(bar);
            tr.appendChild(note);
          }else{
            const note = document.createElement("div");
            note.className = "mutedSmall";
            note.textContent = "Fortschritt: ‚Äî";
            tr.appendChild(note);
          }
        }

        tWrap.appendChild(tr);
      }
    }

    sT.appendChild(tWrap);
    details.appendChild(sT);

    // HUMORSTATISTIK
    const sH = document.createElement("div");
    sH.className = "section";
    const stH = document.createElement("div");
    stH.className = "sectionTitle";
    stH.textContent = "HUMORSTATISTIK";
    sH.appendChild(stH);

    const kvH = document.createElement("div");
    kvH.className = "kv";
    let [hk, hv] = buildRowKV("Gesamtstunden", row["Gesamtstunden (Humorstatistik)"]);
    kvH.appendChild(hk); kvH.appendChild(hv);
    [hk, hv] = buildRowKV("% Lebenszeit", row["% Lebenszeit (Humorstatistik)"]);
    kvH.appendChild(hk); kvH.appendChild(hv);
    [hk, hv] = buildRowKV("Jahre", row["Jahre (Humorstatistik)"]);
    kvH.appendChild(hk); kvH.appendChild(hv);

    sH.appendChild(kvH);
    details.appendChild(sH);

    card.appendChild(details);

    // toggle logic
    tog.addEventListener("click", () => {
      const open = details.classList.toggle("open");
      tog.classList.toggle("open", open);
      tog.querySelector(".txt").textContent = open ? "Weniger Details" : "Mehr Details";
    });

    return card;
  }

  function miniBadge(text, cls){
    const d = document.createElement("div");
    d.className = "miniPill " + (cls || "");
    d.textContent = text;
    return d;
  }

  function buildPlaytime(row){
    const m = fmtVal(row["Spielzeit (Main)"]);
    const c = fmtVal(row["Spielzeit (100%)"]);
    // show "12h / 16h" if both numeric-ish; keep simple
    if(m !== "‚Äî" || c !== "‚Äî"){
      const mm = m === "‚Äî" ? "‚Äî" : `${m}`;
      const cc = c === "‚Äî" ? "‚Äî" : `${c}`;
      return `${mm} / ${cc}`;
    }
    return "‚Äî";
  }

  function renderNextBatch(initial){
    const list = $("cards");
    const total = state.rowsView.length;
    if(state.rendered >= total){
      setCount(`Treffer: ${total} ¬∑ angezeigt: ${total}/${total}`);
      return;
    }

    const end = Math.min(total, state.rendered + state.batch);
    for(let i=state.rendered;i<end;i++){
      list.appendChild(cardEl(state.rowsView[i]));
    }
    state.rendered = end;
    setCount(`Treffer: ${total} ¬∑ angezeigt: ${state.rendered}/${total}`);
  }

  function renderTable(rows){
    const wrap = $("tableWrap");
    wrap.innerHTML = "";

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const cols = ["ID","Spieletitel","System","Quelle","Genre","Entwickler","Spielzeit (Main)","Metascore","Userwertung","% Lebenszeit (Humorstatistik)"];
    for(const c of cols){
      const th = document.createElement("th");
      th.textContent = c === "% Lebenszeit (Humorstatistik)" ? "Lebenszeit %" : c;
      trh.appendChild(th);
    }
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    // Keep table reasonably sized for mobile: show up to 250 rows
    const max = Math.min(rows.length, 250);
    for(let i=0;i<max;i++){
      const r = rows[i];
      const tr = document.createElement("tr");
      for(const c of cols){
        const td = document.createElement("td");
        const val = fmtVal(r[c]);
        if(c === "Spieletitel"){
          td.innerHTML = `<b>${escapeHtml(val)}</b>`;
        }else{
          td.textContent = val;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    wrap.appendChild(table);

    const note = document.createElement("div");
    note.className = "statusLine";
    note.textContent = `Tabellenansicht zeigt aus Performance-Gr√ºnden max. ${max} Zeilen (Kartenansicht hat Infinite Scroll).`;
    wrap.appendChild(note);
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // -------------------------
  // Infinite scroll observer
  // -------------------------
  let io = null;
  function setupInfiniteScroll(){
    if(io) io.disconnect();
    io = new IntersectionObserver((entries) => {
      const hit = entries.some(e => e.isIntersecting);
      if(hit && state.viewMode === "cards"){
        renderNextBatch(false);
      }
    }, { root:null, rootMargin:"900px 0px", threshold:0.01 });

    io.observe($("sentinel"));
  }

  // -------------------------
  // Menu + header collapse (no flicker)
  // -------------------------
  let lastScrollY = 0;
  let ticking = false;
  function onScroll(){
    if(ticking) return;
    ticking = true;
    requestAnimationFrame(() => {
      const y = window.scrollY || 0;
      const dy = y - lastScrollY;
      lastScrollY = y;

      // show/hide "Top" button
      $("btnTop").style.display = y > 400 ? "block" : "none";

      ticking = false;
    });
  }

  // -------------------------
  // Event wiring
  // -------------------------
  function syncUIFromState(){
    $("q").value = state.q;
    $("sortKey").value = state.sortKey;
    $("viewMode").value = state.viewMode;

    // chips
    const chips = $("chips").querySelectorAll(".chip[data-filter]");
    chips.forEach(ch => {
      const f = ch.getAttribute("data-filter");
      ch.classList.toggle("on", state.filters.has(f));
    });

    // menu
    $("menu").classList.toggle("open", state.menuOpen);
  }

  function init(){
    loadState();
    syncUIFromState();

    $("file").addEventListener("change", e => handleFile(e.target.files[0]));
    $("sheet").addEventListener("change", e => loadSheet(e.target.value));

    $("q").addEventListener("input", () => {
      // tiny debounce
      clearTimeout(window.__qT);
      window.__qT = setTimeout(applyAll, 120);
    });

    $("btnMenu").addEventListener("click", () => {
      state.menuOpen = !state.menuOpen;
      $("menu").classList.toggle("open", state.menuOpen);
      saveState();
    });

    $("viewMode").addEventListener("change", (e) => {
      state.viewMode = e.target.value;
      applyAll();
    });

    $("sortKey").addEventListener("change", (e) => {
      state.sortKey = e.target.value;
      applyAll();
    });

    $("sortAsc").addEventListener("click", () => {
      state.sortDir = "asc";
      applyAll();
    });

    $("sortDesc").addEventListener("click", () => {
      state.sortDir = "desc";
      applyAll();
    });

    $("chips").addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if(!chip) return;

      if(chip.id === "clearFilters"){
        state.filters.clear();
        syncUIFromState();
        applyAll();
        return;
      }

      const f = chip.getAttribute("data-filter");
      if(!f) return;

      if(state.filters.has(f)) state.filters.delete(f);
      else state.filters.add(f);

      chip.classList.toggle("on", state.filters.has(f));
      applyAll();
    });

    $("btnTop").addEventListener("click", () => {
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    window.addEventListener("scroll", onScroll, { passive:true });
    setupInfiniteScroll();

    // initialize button state
    $("btnTop").style.display = "none";
    setStatus("Datei w√§hlen ‚Üí Sheet w√§hlen ‚Üí suchen");
  }

  init();
})();
</script>
</body>
</html>