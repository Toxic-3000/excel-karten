<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Spieleliste</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg: Canvas;
      --fg: CanvasText;
      --muted: color-mix(in oklab, CanvasText 55%, Canvas 45%);
      --card: color-mix(in oklab, Canvas 92%, CanvasText 8%);
      --border: color-mix(in oklab, CanvasText 14%, Canvas 86%);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --chip: color-mix(in oklab, CanvasText 6%, Canvas 94%);
      --chip2: color-mix(in oklab, CanvasText 10%, Canvas 90%);
      --ok: #1f8f4a;
      --warn: #c59a00;
      --danger: #cc3b3b;
      --progress: color-mix(in oklab, #2a6fdb 55%, CanvasText 45%);
      --radius: 18px;
      --radius2: 24px;
      --maxw: 980px;
      --badgeW: 150px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--fg);
    }
    .muted{color:var(--muted)}
    .hidden{display:none!important}

    header{
      position: sticky;
      top:0;
      z-index:50;
      background: color-mix(in oklab, Canvas 86%, transparent 14%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 12px 14px;
    }
    .top{
      max-width: var(--maxw);
      margin: 0 auto;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .title{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 22px;
      flex: 0 0 auto;
    }
    .controls{
      flex: 1 1 auto;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search{
      flex: 1 1 auto;
      display:flex;
      align-items:center;
      gap:10px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, Canvas 94%, CanvasText 6%);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .search input{
      border:0;
      outline:0;
      background:transparent;
      width:100%;
      font-size: 16px;
      color: var(--fg);
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 16px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}

    .bar{
      max-width: var(--maxw);
      margin: 10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      padding: 0 14px;
    }
    .file{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .file input{display:none}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      background: var(--chip);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 800;
    }
    .pill.ok{ background: color-mix(in oklab, var(--ok) 10%, var(--chip)); border-color: color-mix(in oklab, var(--ok) 45%, var(--border)); }
    .pill.bad{ background: color-mix(in oklab, var(--danger) 10%, var(--chip)); border-color: color-mix(in oklab, var(--danger) 45%, var(--border)); }
    select{
      border:1px solid var(--border);
      background: color-mix(in oklab, Canvas 94%, CanvasText 6%);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }

    main{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 12px 14px 84px;
    }
    .stats{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .cardHead{
      display:flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
    .gameTitle{
      font-weight: 950;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .1px;
    }
    .subline{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .chips{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }

    .badgeRow{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--border);
      background: var(--chip2);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 850;
      white-space:nowrap;
    }

    .badge{
      min-width: var(--badgeW);
      justify-content:center;
      text-align:center;
    }
    .badge--ok{
      border-color: color-mix(in oklab, var(--ok) 45%, var(--border));
      background: color-mix(in oklab, var(--ok) 14%, var(--chip2));
    }
    .badge--warn{
      border-color: color-mix(in oklab, var(--warn) 50%, var(--border));
      background: color-mix(in oklab, var(--warn) 14%, var(--chip2));
    }
    .badge--danger{
      border-color: color-mix(in oklab, var(--danger) 45%, var(--border));
      background: color-mix(in oklab, var(--danger) 10%, var(--chip2));
    }
    .badge--progress{
      border-color: color-mix(in oklab, var(--progress) 20%, var(--border));
      background: color-mix(in oklab, var(--progress) 8%, var(--chip2));
    }

    .metaGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      font-size: 13px;
    }
    .metaRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .k{
      min-width: 92px;
      color: var(--muted);
      font-weight: 800;
    }
    .v{ font-weight: 850; }
    
    .chip--id{
      border-color: color-mix(in oklab, #1e5bd7 55%, var(--border));
      background: color-mix(in oklab, #1e5bd7 18%, var(--chip2));
      color: color-mix(in oklab, CanvasText 92%, #1e5bd7 8%);
    }
    @media (max-width:560px){
      :root{ --badgeW: 132px; }
      .cardHead{ flex-direction: column; align-items: stretch; }
            .subline{ gap:6px; }
      .chip{ padding: 6px 9px; }
      .gameTitle{ font-size: 17px; }
    }

@media (max-width:560px){
      .metaGrid{grid-template-columns: 1fr;}
      .k{min-width: 88px;}
    }

    details{
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    summary{
      cursor:pointer;
      list-style:none;
      font-weight: 900;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .sectionLabel{
      margin-top: 10px;
      font-size: 12px;
      letter-spacing: .14em;
      color: var(--muted);
      font-weight: 900;
    }
    .textBlock{
      margin-top: 8px;
      line-height: 1.45;
      color: color-mix(in oklab, CanvasText 82%, Canvas 18%);
      white-space: pre-wrap;
    }

    .trophyBlock{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .tRow{
      display:grid;
      grid-template-columns: 52px 1fr;
      gap: 10px;
      align-items:center;
    }
    .platChip{
      justify-content:flex-start;
      min-width: 52px;
      text-transform: uppercase;
      font-size: 12px;
    }
    .barWrap{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .barTop{
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
    }
    .progressBar{
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, CanvasText 6%, Canvas 94%);
      overflow:hidden;
    }
    .progressBar > div{
      height:100%;
      width:0%;
      background: color-mix(in oklab, Highlight 55%, CanvasText 45%);
    }
    .tBadges{
      margin-top: 6px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }

    .backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.45);
      z-index:80;
    }
    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:90;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow: 0 -10px 30px rgba(0,0,0,.25);
      max-height: 78vh;
      overflow:auto;
      padding:10px 12px 14px;
    }
    .handle{
      width:52px;height:5px;border-radius:999px;
      background: color-mix(in oklab, CanvasText 22%, Canvas 78%);
      margin: 6px auto 10px;
    }
    .sheetHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 2px 2px 10px;
    }
    .sheetTitle{font-weight: 950; font-size: 16px;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width:560px){ .grid{grid-template-columns:1fr;} }

    .toTop{
      position: fixed;
      right: 14px;
      bottom: 18px;
      z-index: 60;
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
    }
  </style>
  <!-- v6.1: XLSX lokal (neben index.html) -->
  <script>
    (function(){
      const oldOnError = window.onerror;
      window.__lastErr = null;
      window.onerror = function(msg, src, line, col, err){
        window.__lastErr = {msg:String(msg||''), src:String(src||''), line:line||0, col:col||0, stack: err && err.stack ? String(err.stack) : ''};
        try{
          const jsP = document.getElementById('pillJS');
          if (jsP){ jsP.textContent = 'JS: Fehler'; jsP.classList.remove('ok'); jsP.classList.add('bad'); }
          const box = document.getElementById('errBox');
          if (box){
            box.style.display = 'block';
            box.textContent = 'JS-Fehler: ' + window.__lastErr.msg + (window.__lastErr.line ? (' @' + window.__lastErr.line + ':' + window.__lastErr.col) : '') + (window.__lastErr.src ? ('\n' + window.__lastErr.src) : '') + (window.__lastErr.stack ? ('\n\n' + window.__lastErr.stack) : '');
          }
        }catch(e){}
        if (oldOnError) return oldOnError.apply(this, arguments);
        return false;
      };
    })();
  </script>

</head>

<body>
  <header>
    <div class="top">
      <div class="title">Spieleliste</div>

      <div class="controls">
        <div class="search">
          <input id="search" type="search" placeholder="Suche‚Ä¶" disabled>
        </div>
        <button id="btnMenu" class="btn" type="button" disabled aria-haspopup="dialog" aria-controls="sheet">
          ‚ò∞
        </button>
      </div>
    </div>

    <div class="bar">
      <div class="file">
        <label class="btn" style="cursor:pointer;">
          <input id="file" type="file" accept=".xlsx,.xls,.xlsm" onchange="window._fileChanged && window._fileChanged(event)">
          XLSX laden
        </label>

        <select id="sheetSelect" disabled></select>

        <span id="hitline" class="pill">Treffer: 0 ¬∑ angezeigt: 0/0</span>
        <span id="lib" class="pill">XLSX: ‚Ä¶</span>
        <span id="filepill" class="pill">Datei: ‚Äî</span>
        <span id="jspill" class="pill">JS: ‚Ä¶</span>
      </div>

      <button id="btnReset" class="btn" type="button" disabled>Reset</button>
    </div>
  </header>

  <main>
    <div id="stats" class="stats hidden"></div>
    <section id="list" class="list"></section>
    <div id="sentinel" style="height:1px;"></div>
  </main>

  <button id="toTop" class="btn toTop hidden" type="button">‚Üë Top</button>

  <div id="backdrop" class="backdrop hidden" aria-hidden="true"></div>
  <section id="sheet" class="sheet hidden" role="dialog" aria-modal="true" aria-label="Filter und Sortierung">
    <div class="handle"></div>
    <div class="sheetHead">
      <div class="sheetTitle">Filter & Sortieren</div>
      <button id="btnClose" class="btn" type="button">Schlie√üen</button>
    </div>

    <div class="grid">
      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">SORTIEREN</div>
        <select id="sort" disabled>
          <option value="id_asc">ID (aufsteigend)</option>
          <option value="id_desc">ID (absteigend)</option>
          <option value="title_asc">Titel (A‚ÄìZ)</option>
          <option value="title_desc">Titel (Z‚ÄìA)</option>
          <option value="score_desc">Metascore (hoch ‚Üí niedrig)</option>
          <option value="score_asc">Metascore (niedrig ‚Üí hoch)</option>
        </select>
      </label>

      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">ANZEIGE</div>
        <select id="view" disabled>
          <option value="detail">Detail</option>
          <option value="compact">Kompakt</option>
        </select>
      </label>

      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">PLATTFORM</div>
        <select id="platform" disabled>
          <option value="ALL">Alle</option>
          <option value="PS5">PS5</option>
          <option value="PS4">PS4</option>
          <option value="PS3">PS3</option>
          <option value="VITA">Vita</option>
        </select>
      </label>

      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">TROPH√ÑEN</div>
        <select id="trophy" disabled>
          <option value="ALL">Alle</option>
          <option value="Platinum">üíé Platin erlangt</option>
          <option value="No-Platinum-Title">Kein Platin</option>
          <option value="Progress">‚è≥ In Arbeit</option>
          <option value="Completed">‚úÖ 100% erreicht</option>
          <option value="Unplayed">üí§ Ungespielt</option>
        </select>
      </label>

      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">VERF√úGBARKEIT</div>
        <select id="avail" disabled>
          <option value="ALL">Alle</option>
          <option value="AVAILABLE">Verf√ºgbar</option>
          <option value="DELISTED">Delisted</option>
        </select>
      </label>

      <label>
        <div class="muted" style="font-size:12px;font-weight:900;letter-spacing:.12em;">FAVORIT</div>
        <select id="fav" disabled>
          <option value="ALL">Alle</option>
          <option value="YES">Nur Favoriten</option>
          <option value="NO">Ohne Favoriten</option>
        </select>
      </label>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
      <button id="clear" class="btn" type="button" disabled>Filter zur√ºcksetzen</button>
      <div class="muted" style="font-size:13px;">
        Trophy-Parsing nutzt <b>3 Spalten</b>: ‚ÄûTroph√§en Fortschritt‚Äú, ‚Äû100%‚Äú, ‚ÄûPlatin‚Äú.
      </div>
    </div>
  </section>

  <script>
    (() => {
      'use strict';

      const PAGE_SIZE = 40;
      const $ = (id) => document.getElementById(id);

      const el = {
        file: $('file'),
        sheetSelect: $('sheetSelect'),
        search: $('search'),
        btnMenu: $('btnMenu'),
        btnReset: $('btnReset'),
        hitline: $('hitline'),
        lib: $('lib'),
        filepill: $('filepill'),
        jspill: $('jspill'),
        stats: $('stats'),
        list: $('list'),
        sentinel: $('sentinel'),
        toTop: $('toTop'),

        backdrop: $('backdrop'),
        sheet: $('sheet'),
        btnClose: $('btnClose'),

        sort: $('sort'),
        view: $('view'),
        platform: $('platform'),
        trophy: $('trophy'),
        avail: $('avail'),
        fav: $('fav'),
        clear: $('clear'),
      };

      // v6.1 Debug-Pills
      if (el.jspill) el.jspill.textContent = 'JS: l√§uft (' + new Date().toLocaleTimeString() + ')';

      const COL = {
        id: ['ID','Id','id'],
        title: ['Spieletitel','Spiel','Titel','Title','Game'],
        developer: ['Entwickler','Developer'],
        genre_main: ['Genre'],
        subgenre: ['Subgenre / Stimmung','Subgenre'],
        genre: ['Genre','Subgenre','Subgenre / Stimmung'],
        main: ['Spielzeit (Main)','Main Story (Std.)','Main'],
        hundred: ['Spielzeit (100%)','100 % (Std.)','100%'],
        metascore: ['Metascore','Pressemeinung (√ò)'],
        userscore: ['Userwertung','Userwertung (√ò)'],
        systems: ['System','Systeme','Platforms'],
        availability: ['Verf√ºgbarkeit','Availability','Store Status'],
        storeLink: ['Store Link','StoreLink','Store URL','Store'],
        source: ['Quelle','Source'],
        desc: ['Kurzbeschreibung','Beschreibung','Description'],
        features: ['Besonderheiten','Features'],
        easter: ['Eastereggs','Easter Eggs','Easter'],
        favorite: ['Favorit','Favorite','Fav'],
        humor_total: ['Gesamtstunden (Humorstatistik)','Gesamtstunden','Humorstatistik ‚Äì Gesamtstunden'],
        humor_pct: ['% Lebenszeit (Humorstatistik)','% Lebenszeit','Humorstatistik ‚Äì % Lebenszeit'],
        humor_years: ['Jahre (Humorstatistik)','Jahre','Humorstatistik ‚Äì Jahre'],

        trophy_progress: ['Troph√§en Fortschritt','Troph√§enfortschritt','Trophy Progress'],
        trophy_100: ['100%','100 %','100% Status'],
        trophy_platinum: ['Platin','Platinum','Platin Status'],
      };

      let workbook = null;
      let currentSheet = null;

      let all = [];
      let filtered = [];
      let cursor = 0;
      let observer = null;

      const state = {
        q: '',
        sort: 'id_asc',
        view: 'compact',
        platform: 'ALL',
        trophy: 'ALL',
        avail: 'ALL',
        fav: 'ALL',
      };

      function norm(v){
        if (v === null || v === undefined) return '';
        return String(v).replace(/\u00A0/g,' ').trim();
      }
      function lower(v){ return norm(v).toLowerCase(); }

      function pick(obj, keys){
        for (const k of keys){
          if (Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
        }
        const map = Object.keys(obj).reduce((a,k)=> (a[k.toLowerCase()]=k, a), {});
        for (const k of keys){
          const hit = map[String(k).toLowerCase()];
          if (hit) return obj[hit];
        }
        return undefined;
      }
      function pickBySubstring(obj, needles){
        const keys = Object.keys(obj || {});
        const low = keys.map(k => [k, String(k).toLowerCase()]);
        for (const needle of needles){
          const n = String(needle).toLowerCase();
          const hit = low.find(([k,kl]) => kl.includes(n));
          if (hit) return obj[hit[0]];
        }
        return undefined;
      }

      function parseIntLoose(v){
        const s = norm(v);
        if (!s) return null;
        const n = parseInt(s.replace(/[^\d-]/g,''), 10);
        return Number.isFinite(n) ? n : null;
      }
      function parseFloatLoose(v){
        const s = norm(v);
        if (!s) return null;
        const n = parseFloat(s.replace(',', '.'));
        return Number.isFinite(n) ? n : null;
      }
      function parseScore(v){
        const s = norm(v);
        if (!s) return null;
        const m = s.match(/(\d+(?:[.,]\d+)?)/);
        if (!m) return null;
        const n = parseFloat(m[1].replace(',', '.'));
        return Number.isFinite(n) ? n : null;
      }
      function fmtScore(v){
        const n = parseScore(v);
        if (n === null) return '';
        const s = Number.isInteger(n) ? String(n) : n.toFixed(1);
        return `${s} / 100`;
      }
      function fmt4(v){
        const n = parseFloatLoose(v);
        if (n === null) return '';
        return n.toFixed(4).replace('.', ',');
      }
      function fmtHours(v){
        const n = parseFloatLoose(v);
        if (n === null) return '';
        return Number.isInteger(n) ? String(n) : String(n).replace('.', ',');
      }

      function parseSystems(v){
        const s = norm(v);
        if (!s) return [];
        return s.split(',').map(x=>norm(x)).filter(Boolean).map(x=>x.toUpperCase() === 'VITA' ? 'VITA' : x.toUpperCase());
      }
      function isDelisted(v){
        const s = lower(v);
        if (!s) return false;
        return s.includes('delisted') || s.includes('nicht mehr') || s.includes('nichtmehr');
      }

      function escapeHtml(s){
        return norm(s).replace(/[&<>\"']/g, m => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
      }

      function parsePlatformPairs(text){
        const s = norm(text);
        const out = new Map();
        if (!s) return out;

        const lines = s.split(/\r?\n/).map(x => x.trim()).filter(Boolean);

        // single-line: "PS4 18 of 18" or "PS5 Completed"
        for (const line of lines){
          const m = line.match(/^(PS5|PS4|PS3|VITA)\s+(.+)$/i);
          if (m){
            out.set(m[1].toUpperCase(), m[2].trim());
          }
        }

        // two-line blocks: platform line followed by value line
        const isPlat = (x) => /^(PS5|PS4|PS3|VITA)$/i.test(x);
        for (let i = 0; i < lines.length; i++){
          if (isPlat(lines[i])){
            const p = lines[i].toUpperCase();
            const next = lines[i+1];
            if (next && !isPlat(next)){
              if (!out.has(p)) out.set(p, next.trim());
              i += 1;
            }
          }
        }
        return out;
      }

      function parseCount(text){
        const s = norm(text);
        const m = s.match(/(\d+)\s*of\s*(\d+)/i);
        if (!m) return null;
        const got = parseInt(m[1], 10);
        const total = parseInt(m[2], 10);
        if (!Number.isFinite(got) || !Number.isFinite(total) || total <= 0) return null;
        const percent = Math.max(0, Math.min(100, Math.round((got/total)*100)));
        return { got, total, percent };
      }

      // v6.1: "Kein Platin" ist ein Flag, unabh√§ngig vom Fortschritt
      function trophySummaryFromColumns(progressText, hundredText, platinumText, systems){
        const prog = parsePlatformPairs(progressText);
        const hund = parsePlatformPairs(hundredText);
        const plat = parsePlatformPairs(platinumText);

        const wanted = (systems && systems.length)
          ? systems
          : Array.from(new Set([...prog.keys(), ...hund.keys(), ...plat.keys()]));

        const per = wanted.map(p => {
          const key = p.toUpperCase();
          const vProg = prog.get(key) || '';
          const vHund = hund.get(key) || '';
          const vPlat = plat.get(key) || '';

          let platFlag = '';
          if (vPlat === 'Platinum') platFlag = 'Platinum';
          else if (vPlat === 'No-Platinum-Title') platFlag = 'No-Platinum-Title';

          let status = 'Unplayed';
          const c = parseCount(vProg) || parseCount(vHund);
          const got = c ? c.got : 0;
          const total = c ? c.total : null;
          const percent = c ? c.percent : 0;

          const hundLower = vHund.toLowerCase();
          if (hundLower.includes('completed')) status = 'Completed';
          else if (hundLower.includes('in progress')) status = 'Progress';
          else if (total != null && got >= total) status = 'Completed';
          else if (got > 0) status = 'Progress';
          else status = 'Unplayed';

          const missing = !prog.has(key) && !hund.has(key) && !plat.has(key);
          return { platform:key, status, platFlag, got, total, percent, missing };
        });

        return {
          per,
          anyPlatinum: per.some(x => x.platFlag === 'Platinum'),
          anyNoPlat: per.some(x => x.platFlag === 'No-Platinum-Title'),
          anyCompleted: per.some(x => x.status === 'Completed'),
          anyProgress: per.some(x => x.status === 'Progress'),
          allUnplayed: per.every(x => x.status === 'Unplayed')
        };
      }

      function primaryBadges(t){
        const badges = [];
        if (t.anyPlatinum) badges.push({ label:'üíé Platin erlangt', cls:'badge--ok' });
        if (t.anyCompleted) badges.push({ label:'‚úÖ 100% erreicht', cls:'badge--ok' });
        if (t.anyNoPlat) badges.push({ label:'Kein Platin', cls:'badge--warn' });
        if (t.anyProgress) badges.push({ label:'‚è≥ In Arbeit', cls:'badge--progress' });
        if (t.allUnplayed) badges.push({ label:'üí§ Ungespielt', cls:'' });
        return badges;
      }

      function enableUI(on){
        const dis = !on;
        for (const x of [el.sheetSelect, el.search, el.btnMenu, el.btnReset, el.sort, el.view, el.platform, el.trophy, el.avail, el.fav, el.clear]){
          x.disabled = dis;
        }
      }

      function ensureXLSX(){
        if (window.XLSX){
          el.lib.textContent = 'XLSX: ok (lokal)';
          return true;
        }
        el.lib.textContent = 'XLSX: FEHLT';
        alert('XLSX-Library fehlt. Lege xlsx.full.min.js neben index.html (gleiches Verzeichnis).');
        return false;
      }

      function sheetToRows(wb, name){
        const ws = wb.Sheets[name];
        const ref = ws['!ref'];
        if (!ref) return [];
        const range = XLSX.utils.decode_range(ref);

        // headers from first row
        const headers = [];
        for (let c = range.s.c; c <= range.e.c; c++){
          const addr = XLSX.utils.encode_cell({r: range.s.r, c});
          const cell = ws[addr];
          headers.push(cell ? norm(cell.v) : '');
        }

        const lowerHeaders = headers.map(h => String(h||'').toLowerCase());
        const storeColIdx = (() => {
          const exact = lowerHeaders.findIndex(h => h === 'store link' || h === 'storelink');
          if (exact !== -1) return exact;
          const sub = lowerHeaders.findIndex(h => h.includes('store') && h.includes('link'));
          return sub;
        })();

        const rows = [];
        for (let r = range.s.r + 1; r <= range.e.r; r++){
          const obj = {};
          let empty = true;
          for (let c = range.s.c; c <= range.e.c; c++){
            const key = headers[c - range.s.c] || `COL_${c}`;
            const addr = XLSX.utils.encode_cell({r, c});
            const cell = ws[addr];

            let val = cell ? cell.v : '';
            if (val === undefined || val === null) val = '';
            if (typeof val !== 'number') val = norm(val);

            if (storeColIdx !== -1 && (c - range.s.c) === storeColIdx && cell && cell.l && cell.l.Target){
              val = cell.l.Target;
            }

            if (val !== '' && val !== null && val !== undefined) empty = false;
            obj[key] = val;
          }
          if (!empty) rows.push(obj);
        }
        return rows;
      }

      function normalize(rows){
        return rows.map((r, idx) => {
          const id = parseIntLoose(pick(r, COL.id)) ?? (idx+1);
          const title = norm(pick(r, COL.title));
          const dev = norm(pick(r, COL.developer));
          const genreMain = norm(pick(r, COL.genre_main)) || '';
          const subgenre = norm(pick(r, COL.subgenre)) || '';
          const genre = norm(pick(r, COL.genre));
          const main = parseFloatLoose(pick(r, COL.main));
          const hundred = parseFloatLoose(pick(r, COL.hundred));
          const systems = parseSystems(pick(r, COL.systems));

          const tProg = pick(r, COL.trophy_progress) ?? pickBySubstring(r, ['troph√§en fortschritt','trophy progress','trophies progress']);
          const tHund = pick(r, COL.trophy_100) ?? pickBySubstring(r, ['100%']);
          const tPlat = pick(r, COL.trophy_platinum) ?? pickBySubstring(r, ['platin','platinum']);
          const t = trophySummaryFromColumns(tProg, tHund, tPlat, systems);

          const delisted = isDelisted(pick(r, COL.availability));

          const favRaw = lower(pick(r, COL.favorite));
          const favorite = (favRaw === 'x' || favRaw === '1' || favRaw === 'true' || favRaw === 'yes' || favRaw.includes('‚≠ê') || favRaw.includes('favorit'));

          return {
            _i: idx,
            id,
            title,
            dev,
            genre,
            genreMain,
            subgenre,
            main,
            hundred,
            metascore: fmtScore(pick(r, COL.metascore)),
            userscore: fmtScore(pick(r, COL.userscore)),
            systems,
            availability: delisted ? 'Delisted' : 'Verf√ºgbar',
            delisted,
            favorite,
            storeLink: norm(pick(r, COL.storeLink)),
            source: norm(pick(r, COL.source)),
            desc: norm(pick(r, COL.desc)),
            features: norm(pick(r, COL.features)),
            easter: norm(pick(r, COL.easter)),
            trophy: t,
            humor_total: parseIntLoose(pick(r, COL.humor_total)),
            humor_pct: fmt4(pick(r, COL.humor_pct)),
            humor_years: fmt4(pick(r, COL.humor_years)),
          };
        }).filter(x => x.title || x.dev || x.genre);
      }

      function matches(row){
        const q = lower(state.q);
        if (q){
          const hay = `${row.id} ${row.title} ${row.dev} ${row.genre}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (state.platform !== 'ALL'){
          if (!row.systems.includes(state.platform)) return false;
        }

        if (state.avail !== 'ALL'){
          if (state.avail === 'DELISTED' && !row.delisted) return false;
          if (state.avail === 'AVAILABLE' && row.delisted) return false;
        }

        if (state.fav !== 'ALL'){
          if (state.fav === 'YES' && !row.favorite) return false;
          if (state.fav === 'NO' && row.favorite) return false;
        }

        if (state.trophy !== 'ALL'){
          const t = row.trophy;
          if (state.trophy === 'Platinum' && !t.anyPlatinum) return false;
          if (state.trophy === 'No-Platinum-Title' && !t.anyNoPlat) return false;
          if (state.trophy === 'Progress' && !t.anyProgress) return false;
          if (state.trophy === 'Completed' && !t.anyCompleted) return false;
          if (state.trophy === 'Unplayed' && !t.allUnplayed) return false;
        }

        return true;
      }

      function sortRows(rows){
        const a = [...rows];
        const cmp = (x,y) => {
          switch(state.sort){
            case 'id_asc': return (x.id??0) - (y.id??0);
            case 'id_desc': return (y.id??0) - (x.id??0);
            case 'title_asc': return x.title.localeCompare(y.title,'de',{sensitivity:'base'});
            case 'title_desc': return y.title.localeCompare(x.title,'de',{sensitivity:'base'});
            case 'score_desc': return (parseScore(y.metascore)??-1) - (parseScore(x.metascore)??-1);
            case 'score_asc': return (parseScore(x.metascore)??999) - (parseScore(y.metascore)??999);
            default: return 0;
          }
        };
        a.sort((x,y)=> {
          const d = cmp(x,y);
          return d !== 0 ? d : (x._i - y._i);
        });
        return a;
      }

      function apply(){
        filtered = sortRows(all.filter(matches));
        cursor = 0;
        el.list.innerHTML = '';
        renderStats();
        renderNext();
      }

      function renderStats(){
        const shown = filtered.length;
        const total = all.length;
        el.hitline.textContent = `Treffer: ${shown} ¬∑ angezeigt: ${Math.min(cursor,shown)}/${shown}`;

        const plat = filtered.filter(x=>x.trophy.anyPlatinum).length;
        const done = filtered.filter(x=>x.trophy.anyCompleted).length;
        const prog = filtered.filter(x=>x.trophy.anyProgress).length;
        const unpl = filtered.filter(x=>x.trophy.allUnplayed).length;
        const fav = filtered.filter(x=>x.favorite).length;

        el.stats.classList.remove('hidden');
        el.stats.innerHTML = `
          <span class="pill">üíé Platin: <b>${plat}</b></span>
          <span class="pill">‚úÖ 100%: <b>${done}</b></span>
          <span class="pill">‚è≥ In Arbeit: <b>${prog}</b></span>
          <span class="pill">üí§ Ungespielt: <b>${unpl}</b></span>
          <span class="pill">‚≠ê Favorit: <b>${fav}</b></span>
          <span class="pill">${shown} / ${total}</span>
        `;
      }

      function renderNext(){
        const slice = filtered.slice(cursor, cursor + PAGE_SIZE);
        cursor += slice.length;

        const frag = document.createDocumentFragment();
        for (const row of slice) frag.appendChild(renderCard(row));
        el.list.appendChild(frag);

        el.hitline.textContent = `Treffer: ${filtered.length} ¬∑ angezeigt: ${Math.min(cursor,filtered.length)}/${filtered.length}`;
        syncToggleSummaries(el.list);

        if (cursor >= filtered.length){
          if (observer) observer.disconnect();
          observer = null;
        } else {
          ensureObserver();
        }
      }

      function ensureObserver(){
        if (observer) return;
        observer = new IntersectionObserver((entries)=>{
          for (const e of entries){
            if (e.isIntersecting) renderNext();
          }
        }, { root:null, rootMargin:'450px', threshold:0.01 });
        observer.observe(el.sentinel);
      }

      function renderCard(row){
        const card = document.createElement('article');
        card.className = 'card';

        const topBadges = [];
        if (row.favorite) topBadges.push(`<span class="chip badge">‚≠ê Favorit</span>`);
        for (const b of primaryBadges(row.trophy)){
          topBadges.push(`<span class="chip badge ${b.cls}">${escapeHtml(b.label)}</span>`);
        }
        if (row.delisted) topBadges.push(`<span class="chip badge badge--danger">Delisted</span>`);

        const sysChips = row.systems.map(p => `<span class="chip">${escapeHtml(p === 'VITA' ? 'Vita' : p)}</span>`).join('');
        const idChip = `<span class="chip chip--id">ID ${escapeHtml(row.id)}</span>`;
        const availChip = `<span class="chip">${escapeHtml(row.availability)}</span>`;

        const hours = (row.main != null || row.hundred != null)
          ? `${row.main != null ? fmtHours(row.main) : '‚Äì'}h / ${row.hundred != null ? fmtHours(row.hundred) : '‚Äì'}h`
          : '';

        const metasDetail = `
          <div class="metaGrid">
            ${(row.genreMain || row.genre) ? `<div class="metaRow"><div class="k">Genre</div><div class="v">${escapeHtml(row.genreMain || row.genre)}</div></div>` : ''}
            ${row.subgenre ? `<div class="metaRow"><div class="k">Subgenre</div><div class="v">${escapeHtml(row.subgenre)}</div></div>` : ''}
            ${row.dev ? `<div class="metaRow"><div class="k">Entwickler</div><div class="v">${escapeHtml(row.dev)}</div></div>` : ''}
            ${hours ? `<div class="metaRow"><div class="k">Spielzeit</div><div class="v">${escapeHtml(hours)}</div></div>` : ''}
            ${row.metascore ? `<div class="metaRow"><div class="k">Metascore</div><div class="v">${escapeHtml(row.metascore)}</div></div>` : ''}
            ${row.userscore ? `<div class="metaRow"><div class="k">Userwertung</div><div class="v">${escapeHtml(row.userscore)}</div></div>` : ''}
          </div>
        `;

        const metasCompactExpanded = `
          <div class="metaGrid">
            ${row.subgenre ? `<div class="metaRow"><div class="k">Subgenre</div><div class="v">${escapeHtml(row.subgenre)}</div></div>` : ((row.genreMain || row.genre) ? `<div class="metaRow"><div class="k">Genre</div><div class="v">${escapeHtml(row.genreMain || row.genre)}</div></div>` : '')}
            ${row.dev ? `<div class="metaRow"><div class="k">Entwickler</div><div class="v">${escapeHtml(row.dev)}</div></div>` : ''}
            ${hours ? `<div class="metaRow"><div class="k">Spielzeit</div><div class="v">${escapeHtml(hours)}</div></div>` : ''}
            ${row.metascore ? `<div class="metaRow"><div class="k">Metascore</div><div class="v">${escapeHtml(row.metascore)}</div></div>` : ''}
            ${row.userscore ? `<div class="metaRow"><div class="k">Userwertung</div><div class="v">${escapeHtml(row.userscore)}</div></div>` : ''}
          </div>
        `;

        const trophy = renderTrophies(row.trophy);

        const humor = (row.humor_total != null || row.humor_pct || row.humor_years) ? `
          <div class="sectionLabel">HUMORSTATISTIK</div>
          <div class="metaGrid">
            ${row.humor_total != null ? `<div class="metaRow"><div class="k">Gesamtstunden</div><div class="v">${escapeHtml(row.humor_total)}</div></div>` : ''}
            ${row.humor_pct ? `<div class="metaRow"><div class="k">% Lebenszeit</div><div class="v">${escapeHtml(row.humor_pct)}</div></div>` : ''}
            ${row.humor_years ? `<div class="metaRow"><div class="k">Jahre</div><div class="v">${escapeHtml(row.humor_years)}</div></div>` : ''}
          </div>
        ` : '';

        const store = (row.source || row.storeLink || row.availability) ? `
          <details class="toggleDetails" data-more="Store anzeigen" data-less="Store verbergen">
            <summary>Store anzeigen</summary>
            <div class="sectionLabel">STORE</div>
            <div class="metaGrid">
              ${row.source ? `<div class="metaRow"><div class="k">Quelle</div><div class="v">${escapeHtml(row.source)}</div></div>` : ''}
              ${row.storeLink ? `<div class="metaRow"><div class="k">Store</div><div class="v"><a href="${escapeHtml(row.storeLink)}" target="_blank" rel="noopener">Store Link</a></div></div>` : ''}
              <div class="metaRow"><div class="k">Verf√ºgbarkeit</div><div class="v">${escapeHtml(row.availability)}</div></div>
            </div>
          </details>
        ` : '';

        const desc = row.desc ? `
          <details class="toggleDetails" data-more="Beschreibung anzeigen" data-less="Beschreibung verbergen">
            <summary>Beschreibung anzeigen</summary>
            <div class="sectionLabel">BESCHREIBUNG</div>
            <div class="textBlock">${escapeHtml(row.desc)}</div>
          </details>
        ` : '';

        const features = row.features ? `
          <details>
            <summary>Besonderheiten anzeigen</summary>
            <div class="sectionLabel">EXTRAS</div>
            <div class="textBlock">${escapeHtml(row.features)}</div>
          </details>
        ` : '';

        const easter = row.easter ? `
          <details>
            <summary>Eastereggs anzeigen</summary>
            <div class="textBlock">${escapeHtml(row.easter)}</div>
          </details>
        ` : '';

        const compactToggle = (state.view === 'compact')
          ? `
            <details class="toggleDetails" data-more="Mehr Details" data-less="Weniger Details">
              <summary>Mehr Details</summary>
              ${state.view === 'compact' ? metasCompactExpanded : metasDetail}
              ${desc}
              ${store}
              ${features}
              ${easter}
              <details class="toggleDetails" data-more="Troph√§en anzeigen" data-less="Troph√§en verbergen">
                <summary>Troph√§en anzeigen</summary>
                <div class="sectionLabel">TROPH√ÑEN</div>
                ${trophy}
              </details>
              <details class="toggleDetails" data-more="Humorstatistik anzeigen" data-less="Humorstatistik verbergen">
                <summary>Humorstatistik anzeigen</summary>
                ${humor}
              </details>
            </details>
          `
          : `
            ${state.view === 'compact' ? metasCompactExpanded : metasDetail}
            ${desc}
            ${store}
            ${features}
            ${easter}
            <details class="toggleDetails" data-more="Mehr Details" data-less="Weniger Details" open>
              <summary>Weniger Details</summary>
              <details class="toggleDetails" data-more="Troph√§en anzeigen" data-less="Troph√§en verbergen" open>
                <summary>Troph√§en verbergen</summary>
                <div class="sectionLabel">TROPH√ÑEN</div>
                ${trophy}
              </details>
              <details class="toggleDetails" data-more="Humorstatistik anzeigen" data-less="Humorstatistik verbergen">
                <summary>Humorstatistik anzeigen</summary>
                ${humor}
              </details>
            </details>
          `;

        card.innerHTML = `
          <div class="cardHead">
            <div>
              <div class="gameTitle">${escapeHtml(row.title || '(ohne Titel)')}</div>
              <div class="subline">${idChip}${sysChips}${availChip}</div>
              ${(state.view === 'compact') && (row.genreMain || row.genre) ? `<div class="subline" style="margin-top:6px;"><span class="chip">${escapeHtml(row.genreMain || row.genre)}</span></div>` : ''}
              
            </div>
            <div class="badgeRow">
              ${topBadges.join('')}
            </div>
          </div>
          ${compactToggle}
        `;

        return card;
      }

      function renderTrophies(t){
        const parts = t.per.map(p => {
          const platLabel = (p.platform === 'VITA') ? 'Vita' : p.platform;
          const countText = (p.total != null) ? `${p.got} of ${p.total}` : (p.missing ? '‚Äî' : '');
          const percentText = (p.total != null && p.total > 0) ? `${p.percent}%` : '';

          const bar = `<div class="progressBar"><div style="width:${p.total != null ? p.percent : 0}%"></div></div>`;

          const badges = [];
          if (p.status === 'Completed') badges.push({label:'‚úÖ 100% erreicht', cls:'badge--ok'});
          else if (p.status === 'Progress') badges.push({label:'‚è≥ In Arbeit', cls:'badge--progress'});
          else if (p.status === 'Unplayed') badges.push({label:'üí§ Ungespielt', cls:''});

          if (p.platFlag === 'Platinum') badges.push({label:'üíé Platin erlangt', cls:'badge--ok'});
          else if (p.platFlag === 'No-Platinum-Title') badges.push({label:'Kein Platin', cls:'badge--warn'});

          if (p.missing) badges.push({label:'kein Block ‚Üí ungespielt', cls:''});

          return `
            <div class="tRow">
              <span class="chip platChip">${escapeHtml(platLabel)}</span>
              <div class="barWrap">
                <div class="barTop">
                  <span>${escapeHtml(countText)}</span>
                  <span>${escapeHtml(percentText)}</span>
                </div>
                ${bar}
                <div class="tBadges">
                  ${badges.map(b => `<span class="chip badge ${b.cls}">${escapeHtml(b.label)}</span>`).join('')}
                </div>
              </div>
            </div>
          `;
        }).join('');

        return `<div class="trophyBlock">${parts}</div>`;
      }

      function openSheet(){
        el.backdrop.classList.remove('hidden');
        el.sheet.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }
      function closeSheet(){
        el.backdrop.classList.add('hidden');
        el.sheet.classList.add('hidden');
        document.body.style.overflow = '';
      }

      el.btnMenu.addEventListener('click', () => { if (!el.btnMenu.disabled) openSheet(); });
      el.btnClose.addEventListener('click', closeSheet);
      el.backdrop.addEventListener('click', closeSheet);
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeSheet(); });

      el.btnReset.addEventListener('click', ()=>{
        workbook = null; currentSheet = null;
        all = []; filtered = [];
        cursor = 0;
        if (observer) observer.disconnect();
        observer = null;

        el.sheetSelect.innerHTML = '';
        el.search.value = '';
        el.list.innerHTML = '';
        el.stats.classList.add('hidden');
        el.hitline.textContent = 'Treffer: 0 ¬∑ angezeigt: 0/0';
        el.filepill.textContent = 'Datei: ‚Äî';
        enableUI(false);
        el.file.value = '';
      });

      el.clear.addEventListener('click', ()=>{
        state.q = ''; state.sort = 'id_asc'; state.view = 'compact';
        state.platform='ALL'; state.trophy='ALL'; state.avail='ALL'; state.fav='ALL';
        el.search.value = '';
        el.sort.value = state.sort;
        el.view.value = state.view;
        el.platform.value = state.platform;
        el.trophy.value = state.trophy;
        el.avail.value = state.avail;
        el.fav.value = state.fav;
        apply();
      });

      el.search.addEventListener('input', ()=>{ state.q = el.search.value; apply(); });
      el.sort.addEventListener('change', ()=>{ state.sort = el.sort.value; apply(); });
      el.view.addEventListener('change', ()=>{ state.view = el.view.value; apply(); });
      el.platform.addEventListener('change', ()=>{ state.platform = el.platform.value; apply(); });
      el.trophy.addEventListener('change', ()=>{ state.trophy = el.trophy.value; apply(); });
      el.avail.addEventListener('change', ()=>{ state.avail = el.avail.value; apply(); });
      el.fav.addEventListener('change', ()=>{ state.fav = el.fav.value; apply(); });

      el.sheetSelect.addEventListener('change', ()=>{
        currentSheet = el.sheetSelect.value;
        if (!workbook || !currentSheet) return;
        const rows = sheetToRows(workbook, currentSheet);
        all = normalize(rows);
        state.view = 'compact';
        el.view.value = state.view;
        apply();
        closeSheet();
      });

      el.toTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
      window.addEventListener('scroll', ()=>{
        const y = window.scrollY || document.documentElement.scrollTop;
        el.toTop.classList.toggle('hidden', y < 600);
      }, { passive:true });


      function syncToggleSummaries(root=document){
        const nodes = root.querySelectorAll('details.toggleDetails');
        for (const d of nodes){
          const sum = d.querySelector(':scope > summary');
          if (!sum) continue;
          const more = d.getAttribute('data-more') || 'Mehr Details';
          const less = d.getAttribute('data-less') || 'Weniger Details';
          sum.textContent = d.open ? less : more;
        }
      }

      document.addEventListener('toggle', (e)=>{
        const d = e.target;
        if (d && d.matches && d.matches('details.toggleDetails')){
          syncToggleSummaries(d.parentElement || document);
        }
      }, true);

      // Inline onchange fallback for some Android setups
      window._fileChanged = () => { try{ el.file.dispatchEvent(new Event('change')); }catch{} };

      el.file.addEventListener('change', async ()=>{
        const file = el.file.files && el.file.files[0];
        el.filepill.textContent = 'Datei: ' + (file ? (file.name + ' (' + Math.round(file.size/1024) + ' KB)') : '‚Äî');
        if (!file) return;

        if (!ensureXLSX()) return;

        enableUI(false);
        el.lib.textContent = 'XLSX: lese Datei‚Ä¶';

        try{
          const buf = await file.arrayBuffer();
          workbook = XLSX.read(buf, { type:'array' });

          el.sheetSelect.innerHTML = '';
          for (const name of workbook.SheetNames){
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            el.sheetSelect.appendChild(opt);
          }
          currentSheet = workbook.SheetNames[0];
          el.sheetSelect.value = currentSheet;

          const rows = sheetToRows(workbook, currentSheet);
          all = normalize(rows);

          el.lib.textContent = 'XLSX: ok (lokal)';
          enableUI(true);
          el.search.disabled = false;

          state.view = 'compact';
          el.view.value = state.view;

          apply();
        }catch(err){
          console.error(err);
          alert('Fehler beim Einlesen der XLSX. Details in der Konsole.');
          el.lib.textContent = 'XLSX: Fehler';
          enableUI(false);
        }
      });

      enableUI(false);
      el.lib.textContent = window.XLSX ? 'XLSX: ok (lokal)' : 'XLSX: FEHLT';
    })();
  </script>
</body>
</html>
